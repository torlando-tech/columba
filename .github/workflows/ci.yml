name: CI

on:
  push:
    branches: [ main, 'v[0-9].[0-9]+.x' ]
  pull_request:
    branches: [ main, 'v[0-9].[0-9]+.x' ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-wrapper:
    name: Validate Gradle Wrapper
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

  lint:
    name: Code Quality (ktlint + detekt + CPD)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run all lint checks
        run: ./gradlew ktlintCheck detekt cpdCheck --continue

      - name: Check for forbidden test suppressions
        run: |
          echo "Checking for forbidden @Suppress annotations in test files..."

          # Count files with NoRelaxedMocks suppression
          RELAXED_COUNT=$(grep -r "Suppress.*NoRelaxedMocks" app/src/test reticulum/src/test --include="*.kt" -l 2>/dev/null | wc -l || echo "0")

          # Count files with NoVerifyOnlyTests suppression
          VERIFY_COUNT=$(grep -r "Suppress.*NoVerifyOnlyTests" app/src/test reticulum/src/test --include="*.kt" -l 2>/dev/null | wc -l || echo "0")

          echo "Files with @Suppress(\"NoRelaxedMocks\"): $RELAXED_COUNT"
          echo "Files with @Suppress(\"NoVerifyOnlyTests\"): $VERIFY_COUNT"

          # These rules exist to prevent useless tests that don't test production code.
          # Suppressing them defeats the purpose. Fix the tests instead.
          #
          # BASELINE: Ratchet down over time. Don't increase these numbers.
          # Current state reflects Android framework mocks (Context, BluetoothManager, etc.)
          # that are impractical to stub explicitly. Fix when possible.
          RELAXED_BASELINE=37
          VERIFY_BASELINE=3

          FAIL=false

          if [ "$RELAXED_COUNT" -gt "$RELAXED_BASELINE" ]; then
            echo "::error::NoRelaxedMocks suppressions increased from $RELAXED_BASELINE to $RELAXED_COUNT"
            echo "Do not add @Suppress(\"NoRelaxedMocks\"). Use explicit stubs instead of relaxed mocks."
            FAIL=true
          fi

          if [ "$VERIFY_COUNT" -gt "$VERIFY_BASELINE" ]; then
            echo "::error::NoVerifyOnlyTests suppressions increased from $VERIFY_BASELINE to $VERIFY_COUNT"
            echo "Do not add @Suppress(\"NoVerifyOnlyTests\"). Add assertions to your tests."
            FAIL=true
          fi

          if [ "$FAIL" = true ]; then
            exit 1
          fi

          echo "✓ No new forbidden suppressions found"

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-reports
          path: |
            **/build/reports/ktlint/
            **/build/reports/detekt/
            build/reports/cpd/
          retention-days: 7

  threading-audit:
    name: Threading Architecture Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Make audit script executable
        run: chmod +x audit-dispatchers.sh

      - name: Run dispatcher audit
        id: audit
        run: |
          echo "Running threading architecture audit..."
          ./audit-dispatchers.sh
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: threading-audit-report
          path: dispatcher-audit-report.txt
          retention-days: 30

      - name: Comment audit results on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'Dispatcher audit report not found';
            try {
              report = fs.readFileSync('dispatcher-audit-report.txt', 'utf8');
            } catch (e) {
              console.log('Could not read audit report');
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Threading Architecture Audit Failed\n\n<details><summary>View Audit Report</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>\n\nPlease fix the dispatcher violations before merging.`
            });

  proguard-verification:
    name: Verify ProGuard Rules (Python-Kotlin Bridge)
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: pip install build

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build release APK
        run: ./gradlew :app:assembleSentryRelease --stacktrace --max-workers=2
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}

      - name: Verify Python-Kotlin bridge methods are not obfuscated
        run: |
          # Find the release APK (sentry variant)
          APK_PATH=$(find app/build/outputs/apk/sentry/release -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: No sentry release APK found!"
            exit 1
          fi
          # Run dynamic verification script that extracts methods from Python source
          python scripts/verify_proguard_bridge.py "$APK_PATH"

      - name: Upload R8 mapping file
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: r8-mapping
          path: app/build/outputs/mapping/sentryRelease/mapping.txt
          retention-days: 30

      - name: Upload release APK
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: columba-apk
          path: app/build/outputs/apk/sentry/release/*.apk
          retention-days: 14

  python-tests:
    name: Python Tests
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install build pytest pytest-cov pytest-xdist u-msgpack-python numpy

      - name: Run Python unit tests with coverage
        run: |
          cd python && python -m pytest -v -n auto --dist loadfile \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage-python.xml

      - name: Upload Python coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./python/coverage-python.xml
          flags: python
          name: codecov-python
          fail_ci_if_error: false
          verbose: true

      - name: Upload Python coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: python-coverage-report
          path: python/coverage-python.xml
          retention-days: 7

  kotlin-tests:
    name: Kotlin Tests (Shard ${{ matrix.shard }}/4)
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: pip install build

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean AIDL generated code
        run: |
          # Clean AIDL generated code to avoid stale cache issues
          # This MUST happen before Gradle cache restore to prevent cached stale AIDL files
          rm -rf app/build/generated/aidl_source_output_dir
          rm -rf */build/generated/aidl_source_output_dir

      - name: Clean JaCoCo execution data
        run: |
          # Clean stale JaCoCo execution data to avoid "exceeds max age" errors in Codecov
          rm -rf build/jacoco
          rm -rf */build/jacoco
          rm -rf build/reports/jacoco
          rm -rf */build/reports/jacoco

      - name: Cache Robolectric Android SDKs
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository/org/robolectric
          key: robolectric-4.16-${{ runner.os }}
          restore-keys: |
            robolectric-4.16-
            robolectric-

      - name: Run app unit tests (shard ${{ matrix.shard }})
        # Build cache enabled for faster incremental builds
        # AIDL and JaCoCo caching issues are handled by clean steps above
        # NOTE: For app module, only run noSentry variant (sentry/noSentry share the same test code,
        # differing only in SENTRY_DSN buildConfigField which tests don't exercise).
        run: ./gradlew :app:testNoSentryDebugUnitTest -PtestShard=${{ matrix.shard }} -PtestShardTotal=4 --stacktrace --max-workers=4

      - name: Run reticulum and data module tests
        if: matrix.shard == 0
        run: ./gradlew :reticulum:testDebugUnitTest :data:testDebugUnitTest --stacktrace --max-workers=4

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-test-results-shard-${{ matrix.shard }}
          path: |
            **/build/test-results/test*/*.xml
            **/build/test-results/test*/*.html
          retention-days: 7

      - name: Upload unit test reports
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-test-reports-shard-${{ matrix.shard }}
          path: |
            **/build/reports/tests/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./**/build/reports/jacoco/**/*.xml
          flags: unittests
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
          verbose: true

      - name: Upload Kotlin coverage reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-coverage-reports-shard-${{ matrix.shard }}
          path: |
            **/build/reports/jacoco/
          retention-days: 7

  instrumented-tests:
    name: Instrumented Tests
    # Run in parallel with other jobs
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: pip install build

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean AIDL generated code
        run: |
          # Clean AIDL generated code to avoid stale cache issues
          rm -rf app/build/generated/aidl_source_output_dir
          rm -rf */build/generated/aidl_source_output_dir

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Pre-build test APKs
        run: |
          echo "Building APKs before starting emulator..."
          ./gradlew :app:assembleNoSentryDebugAndroidTest --stacktrace --max-workers=2
          ./gradlew :app:assembleNoSentryDebug --stacktrace --max-workers=2
          echo "APKs built successfully"

      - name: AVD cache
        uses: actions/cache@v5
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-34-x86_64-v6

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -memory 2048
          disable-animations: true
          emulator-boot-timeout: 600
          script: |
            echo "Waiting for emulator to be ready..."
            adb wait-for-device
            adb shell getprop sys.boot_completed | grep -q 1 || sleep 10
            echo "Emulator ready, generating snapshot for caching."

      - name: Run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -memory 2048
          disable-animations: true
          emulator-boot-timeout: 600
          script: |
            echo "Running emulator health check..."
            adb shell getprop ro.build.version.sdk
            adb shell pm list packages | head -5
            echo "Emulator is responsive, starting tests..."
            # Run smoke tests and integration tests
            # Use test orchestrator for isolation (configured in build.gradle.kts)
            ./gradlew :app:connectedNoSentryDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.lxmf.messenger.smoke.SmokeTest,com.lxmf.messenger.integration.MessageDataFlowTest,com.lxmf.messenger.integration.ConversationCreationFlowTest --stacktrace

      - name: Upload instrumented test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: instrumented-test-results
          path: |
            **/build/outputs/androidTest-results/**/*.xml
            **/build/outputs/androidTest-results/**/*.html
          retention-days: 7

      - name: Upload instrumented test reports
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: instrumented-test-reports
          path: |
            **/build/reports/androidTests/
          retention-days: 7

      - name: Capture logcat on failure
        if: failure()
        run: |
          mkdir -p artifacts
          adb logcat -d > artifacts/logcat.log || true

      - name: Upload logcat output
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: logcat
          path: artifacts/logcat.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Cleanup emulator
        if: always()
        run: |
          adb devices | grep emulator | cut -f1 | xargs -I {} adb -s {} emu kill || true
          pkill -9 qemu-system || true
          adb kill-server || true

  ci-passed:
    name: ✅ CI Passed — APK Ready
    if: always()
    needs: [validate-wrapper, lint, threading-audit, proguard-verification, python-tests, kotlin-tests, instrumented-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Check all jobs passed
        run: |
          # Fail this job if any dependency failed or was cancelled
          if [[ "${{ needs.validate-wrapper.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.threading-audit.result }}" != "success" ]] || \
             [[ "${{ needs.proguard-verification.result }}" != "success" ]] || \
             [[ "${{ needs.python-tests.result }}" != "success" ]] || \
             [[ "${{ needs.kotlin-tests.result }}" != "success" ]]; then
            echo "## ❌ CI Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Validate Wrapper | ${{ needs.validate-wrapper.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Threading Audit | ${{ needs.threading-audit.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ProGuard Verification | ${{ needs.proguard-verification.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Python Tests | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Kotlin Tests | ${{ needs.kotlin-tests.result }} |" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: CI Summary
        run: |
          echo "## ✅ All CI checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The **columba-apk** artifact is available for download from the Artifacts section of this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Wrapper | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Threading Audit | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| ProGuard Verification | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Kotlin Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
