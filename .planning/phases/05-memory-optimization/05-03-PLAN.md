---
phase: 05-memory-optimization
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - .planning/phases/05-memory-optimization/05-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "App survives 5+ days continuous runtime without OOM"
    - "Zero OOM crashes in Sentry for 7 days post-release"
    - "Memory growth rate confirmed sustainable via extended testing"
  artifacts:
    - path: ".planning/phases/05-memory-optimization/05-VERIFICATION.md"
      provides: "Verification results and beta release checklist"
      contains: "# Verification Results"
  key_links:
    - from: "Sentry dashboard"
      to: "OOM crash count"
      via: "Sentry event filter"
      pattern: "Out of Memory"
---

<objective>
Verify memory fixes with extended runtime testing and prepare for beta release.

Purpose: Confirm the ~1.4 MB/min memory growth is fixed before shipping to beta testers. Document verification results for post-release monitoring.

Output: Verification documentation confirming sustainable memory usage, beta release checklist with Sentry monitoring criteria.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-memory-optimization/05-CONTEXT.md
@.planning/phases/05-memory-optimization/05-01-SUMMARY.md
@.planning/phases/05-memory-optimization/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check existing Sentry OOM events</name>
  <files>.planning/phases/05-memory-optimization/05-VERIFICATION.md</files>
  <action>
Per CONTEXT.md decision, check existing Sentry OOM events for memory context:

1. Open Sentry dashboard for Columba project
2. Filter events by:
   - Event type: "Out of Memory" or mechanism: "OOM"
   - Time range: Last 30 days
3. For each OOM event, check:
   - Memory context (if available): Native/Dalvik heap values
   - Breadcrumbs: Activity before crash
   - Release version: Which versions affected

4. Document findings:
   - Count of OOM events in last 30 days
   - Current Sentry user count (for success threshold)
   - Common patterns in OOM breadcrumbs

Create `.planning/phases/05-memory-optimization/05-VERIFICATION.md`:
```markdown
# Phase 5 Verification Results

## Pre-Fix Baseline

### Sentry OOM Analysis (YYYY-MM-DD)

| Metric | Value |
|--------|-------|
| OOM events (30 days) | X |
| Active users | Y |
| OOM rate per user | X/Y |

### Common OOM Patterns
- (describe patterns from breadcrumbs)

## Post-Fix Verification

### Extended Runtime Test
- Duration: X hours
- Memory growth: X MB/hour
- Final native heap: X MB

### Profiling Results
- (copy relevant data from 05-02-SUMMARY.md)

## Beta Release Checklist

- [ ] Release build created with memory fixes
- [ ] Sentry release marked
- [ ] 7-day monitoring period started (YYYY-MM-DD)
- [ ] Success criteria: Zero OOM crashes for 7 days
```
  </action>
  <verify>
1. 05-VERIFICATION.md exists with Sentry baseline data
2. Current user count documented
3. Success threshold defined
  </verify>
  <done>
Sentry OOM baseline documented, success criteria for beta release defined.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Extended runtime verification setup</what-built>
  <how-to-verify>
For proper verification, run the app overnight (8+ hours minimum, ideally 24+ hours):

1. Install release build (not debug - different memory characteristics):
   `./gradlew assembleSentryRelease && adb install app/build/outputs/apk/sentry/release/app-sentry-release.apk`

2. Leave app running overnight with screen off
   - Keep phone plugged in
   - Disable battery optimization for Columba
   - Leave on a stable network (WiFi preferred)

3. Next morning, check:
   - Is app still running? `adb shell ps | grep lxmf`
   - Memory usage: `adb shell dumpsys meminfo com.lxmf.messenger | grep -A 5 TOTAL`
   - Any Sentry OOM events overnight?

4. Calculate growth rate:
   - Initial memory (from install time logcat)
   - Final memory (from dumpsys)
   - Duration in hours
   - Growth rate = (Final - Initial) / Duration

Expected: < 1 MB/hour growth (sustainable for 5+ days)

Report back with:
- Duration of test
- Initial and final memory
- Calculated growth rate
- Any crashes or issues observed
  </how-to-verify>
  <resume-signal>Type "approved" with test results, or describe issues observed</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Document verification results and create release checklist</name>
  <files>.planning/phases/05-memory-optimization/05-VERIFICATION.md</files>
  <action>
Update 05-VERIFICATION.md with extended runtime test results:

1. Add test results from checkpoint:
   ```markdown
   ## Extended Runtime Test Results

   ### Test Configuration
   - Build: sentry-release vX.X.X
   - Device: [model]
   - Duration: X hours
   - Network: [type]

   ### Memory Measurements
   | Time | Native Heap | JVM Heap | Total PSS |
   |------|-------------|----------|-----------|
   | Start | X MB | X MB | X MB |
   | End | X MB | X MB | X MB |

   ### Growth Rate
   - Total growth: X MB over X hours
   - Rate: X MB/hour
   - Projected 5-day usage: X MB (within/exceeds device limits)

   ### Verdict
   [PASS/FAIL]: Growth rate is [sustainable/unsustainable] for multi-day operation.
   ```

2. Add beta release checklist with specific monitoring criteria:
   ```markdown
   ## Beta Release Checklist

   ### Pre-Release
   - [ ] Memory fixes verified with < 1 MB/hour growth
   - [ ] Release APK built and signed
   - [ ] Sentry release version set

   ### Post-Release Monitoring (7 days)
   - Start date: YYYY-MM-DD
   - End date: YYYY-MM-DD
   - Success criteria:
     - Zero OOM crashes attributed to this release
     - No memory-related user reports
     - Native heap stable over 24+ hour sessions

   ### Daily Check
   - [ ] Day 1: OOM count = 0
   - [ ] Day 2: OOM count = 0
   - [ ] Day 3: OOM count = 0
   - [ ] Day 4: OOM count = 0
   - [ ] Day 5: OOM count = 0
   - [ ] Day 6: OOM count = 0
   - [ ] Day 7: OOM count = 0
   ```

3. If test FAILED:
   - Document the specific failure mode
   - Add todo for additional investigation
   - Do NOT mark phase as complete
  </action>
  <verify>
1. 05-VERIFICATION.md has complete test results
2. Growth rate calculated and documented
3. Beta release checklist has specific dates
  </verify>
  <done>
Verification results documented, beta release checklist created with 7-day monitoring criteria.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. 05-VERIFICATION.md exists with:
   - Sentry OOM baseline
   - Extended runtime test results
   - Growth rate calculation
   - Beta release checklist
2. Growth rate is < 1 MB/hour (sustainable)
3. Phase can proceed to release if verification passes
</verification>

<success_criteria>
- Extended runtime test shows < 1 MB/hour memory growth
- Sentry baseline documented for post-release comparison
- Beta release checklist ready with 7-day monitoring period defined
- Phase 5 success criteria met: "App survives 5+ days continuous runtime without OOM"
</success_criteria>

<output>
After completion, create `.planning/phases/05-memory-optimization/05-03-SUMMARY.md`
</output>
