---
phase: 11.5
plan: 01
title: Wire Integer Signals from Python to Kotlin
wave: 1
depends_on: []
files_modified:
  - python/lxst_modules/call_manager.py
  - app/src/main/java/com/lxmf/messenger/service/manager/PythonWrapperManager.kt
autonomous: true
estimated_minutes: 10
---

# Plan 11.5-01: Wire Integer Signals from Python to Kotlin

## Goal

Fix the signal type mismatch that prevents Kotlin Telephone from receiving call state transitions. Python LXST callback handlers must call `send_signal(int)` to deliver INTEGER signals to Kotlin in addition to the existing STRING events for UI.

## Gap Being Closed

**Gap 1 from 11-VERIFICATION.md:** Signal Type Mismatch (CRITICAL BLOCKER)

- Python sends STRING events via `_notify_kotlin('established', ...)`
- Kotlin expects INTEGER signals via `onSignalReceived(signal: Int)`
- Result: Kotlin Telephone never transitions to ESTABLISHED, audio pipelines never open

## Root Cause

The `_handle_established()`, `_handle_ringing()`, etc. callbacks in `call_manager.py` only call:
1. `_kotlin_call_bridge.onCallEstablished()` - UI notification (works)
2. `_notify_kotlin('established', ...)` - STRING event (not used by Telephone)

They do NOT call:
3. `send_signal(0x06)` - INTEGER signal (what Telephone needs!)

## Tasks

<task id="1">
<title>Add INTEGER signal calls to Python LXST callbacks</title>
<context>
call_manager.py has `send_signal(int)` method that calls `_kotlin_network_bridge.onPythonSignalReceived(signal)`.
The callback handlers (`_handle_ringing`, `_handle_established`, etc.) must call this method.

Signalling constants (must match Kotlin Signalling object):
- STATUS_BUSY = 0x00
- STATUS_REJECTED = 0x01
- STATUS_CALLING = 0x02
- STATUS_AVAILABLE = 0x03
- STATUS_RINGING = 0x04
- STATUS_CONNECTING = 0x05
- STATUS_ESTABLISHED = 0x06
</context>
<files>python/lxst_modules/call_manager.py</files>
<action>
In each callback handler, add a call to `self.send_signal(signal_constant)` AFTER the existing UI notifications:

1. `_handle_ringing()` - Add: `self.send_signal(0x04)  # STATUS_RINGING`
2. `_handle_established()` - Add: `self.send_signal(0x06)  # STATUS_ESTABLISHED`
3. `_handle_ended()` - Add: `self.send_signal(0x03)  # STATUS_AVAILABLE (call ended)`
4. `_handle_busy()` - Add: `self.send_signal(0x00)  # STATUS_BUSY`
5. `_handle_rejected()` - Add: `self.send_signal(0x01)  # STATUS_REJECTED`

Place the signal call at the END of each handler (after UI notifications but before return).
Add log statement: `RNS.log(f"ðŸ“ž Sent signal {signal:#04x} to Kotlin", RNS.LOG_DEBUG)`
</action>
<verification>
- grep for "send_signal(0x" in call_manager.py shows 5 calls
- Each handler has corresponding signal constant
</verification>
</task>

<task id="2">
<title>Add STATUS_CONNECTING signal for outgoing calls</title>
<context>
For outgoing calls, when the remote answers but before audio starts, Python LXST receives a "connecting" notification. This needs to reach Kotlin so it can transition from RINGING to CONNECTING.

The current handlers don't explicitly handle the CONNECTING state for outgoing calls.
</context>
<files>python/lxst_modules/call_manager.py</files>
<action>
Check if there's a connecting callback or if it's part of _handle_established.

If LXST has separate connecting callback:
- Add handler: `_handle_connecting()`
- Wire to telephone: `self.telephone.set_connecting_callback(self._handle_connecting)`
- Add signal: `self.send_signal(0x05)  # STATUS_CONNECTING`

If LXST doesn't have separate connecting callback (fires established directly):
- In `_handle_established()`, send CONNECTING first, then ESTABLISHED:
  ```python
  # Signal call is connecting (pipelines will open)
  self.send_signal(0x05)  # STATUS_CONNECTING
  # Signal call established (pipelines will start)
  self.send_signal(0x06)  # STATUS_ESTABLISHED
  ```
</action>
<verification>
- Make outgoing call
- Kotlin logs show: `Signal received: 0x05` then `Signal received: 0x06`
</verification>
</task>

<task id="3">
<title>Add signalling constants to call_manager.py</title>
<context>
Magic numbers (0x00-0x06) are hard to read. Add named constants for clarity.
</context>
<files>python/lxst_modules/call_manager.py</files>
<action>
Add constants at the top of the class (after PROFILE constants):

```python
# Signalling constants (match Kotlin Signalling object)
STATUS_BUSY = 0x00
STATUS_REJECTED = 0x01
STATUS_CALLING = 0x02
STATUS_AVAILABLE = 0x03
STATUS_RINGING = 0x04
STATUS_CONNECTING = 0x05
STATUS_ESTABLISHED = 0x06
```

Update `send_signal()` calls to use constants:
- `self.send_signal(self.STATUS_RINGING)`
- `self.send_signal(self.STATUS_ESTABLISHED)`
- etc.
</action>
<verification>
- Constants defined in class
- All send_signal calls use named constants
</verification>
</task>

<task id="4">
<title>Verify NetworkPacketBridge receives signals</title>
<context>
NetworkPacketBridge.onPythonSignalReceived(signal: Int) invokes the callback registered by Telephone.
Need to verify the callback is actually registered.
</context>
<files>
app/src/main/java/com/lxmf/messenger/service/manager/PythonWrapperManager.kt
reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt
</files>
<action>
1. In PythonWrapperManager.setupTelephone(), verify NetworkPacketBridge callback is registered:
   - Telephone constructor registers via `networkTransport.setSignalCallback { ... }`
   - PythonNetworkTransport.setSignalCallback delegates to NetworkPacketBridge

2. Add debug log in NetworkPacketBridge.onPythonSignalReceived():
   ```kotlin
   fun onPythonSignalReceived(signal: Int) {
       Log.d(TAG, "ðŸ“ž Signal from Python: ${signal.toString(16)}")
       onSignalReceived?.invoke(signal)
   }
   ```

Note: This log can remain since signals are infrequent (not hot path like audio packets).
</action>
<verification>
- Build succeeds
- During call, logcat shows: `ðŸ“ž Signal from Python: 6`
</verification>
</task>

## Verification Criteria

After implementing all tasks:

1. **Signal flow verified:**
   - Make outgoing call
   - Logcat shows: `Columba:NetBridge: ðŸ“ž Signal from Python: 5` (CONNECTING)
   - Logcat shows: `Columba:NetBridge: ðŸ“ž Signal from Python: 6` (ESTABLISHED)
   - Logcat shows: `Columba:Telephone: Signal received: 0x05`
   - Logcat shows: `Columba:Telephone: Signal received: 0x06`

2. **Kotlin state machine transitions:**
   - `callStatus` goes: CALLING â†’ RINGING â†’ CONNECTING â†’ ESTABLISHED
   - `openPipelines()` called when CONNECTING received
   - `startPipelines()` called when ESTABLISHED received

3. **Audio pipeline activation:**
   - After ESTABLISHED, Kotlin audio logs should appear
   - Python LXST audio still runs (disabled in Phase 11.6)

## must_haves

From Phase 11.5 success criteria in ROADMAP.md:

- [ ] NetworkPacketBridge has `receiveSignal(int)` method callable from Python â€” ALREADY EXISTS as `onPythonSignalReceived(int)`
- [ ] Python call_manager forwards LXST signals as integers to Kotlin â€” THIS PLAN
- [ ] Kotlin logs show `Signal received: 0x06` when call establishes â€” THIS PLAN
- [ ] Kotlin Telephone transitions through CONNECTING â†’ ESTABLISHED â€” THIS PLAN

## Anti-patterns to Avoid

- Do NOT remove existing `_notify_kotlin()` calls - UI still needs them
- Do NOT remove existing `_kotlin_call_bridge` calls - UI state needs them
- Do NOT add logging in audio packet path (hot path)
- Signal logs are OK since signals are infrequent (~1-5 per call)
