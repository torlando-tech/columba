---
phase: 02.2-offline-map-tile-rendering
plan: 02
type: execute
wave: 2
depends_on: ["02.2-01"]
files_modified:
  - app/src/main/java/com/lxmf/messenger/map/MapTileSourceManager.kt
  - app/src/main/java/com/lxmf/messenger/ui/screens/MapScreen.kt
autonomous: false

must_haves:
  truths:
    - "Offline maps render full vector tile detail (roads, buildings, labels) after extended offline periods"
    - "MapScreen loads style from local JSON file when offline, not from HTTP URL"
    - "Online mode is unaffected - still loads style from HTTP URL as before"
    - "Existing offline regions without cached style JSON fall back to HTTP URL (graceful degradation)"
  artifacts:
    - path: "app/src/main/java/com/lxmf/messenger/map/MapTileSourceManager.kt"
      provides: "MapStyleResult.OfflineWithLocalStyle variant and offline style resolution"
      contains: "OfflineWithLocalStyle"
    - path: "app/src/main/java/com/lxmf/messenger/ui/screens/MapScreen.kt"
      provides: "Style.Builder().fromJson() handling for offline local styles"
      contains: "fromJson"
  key_links:
    - from: "MapTileSourceManager.kt"
      to: "OfflineMapRegionRepository.kt"
      via: "getFirstCompletedRegionWithStyle() to find cached style path"
      pattern: "getFirstCompletedRegionWithStyle"
    - from: "MapScreen.kt"
      to: "MapTileSourceManager.kt"
      via: "handling OfflineWithLocalStyle in when(styleResult) block"
      pattern: "OfflineWithLocalStyle.*fromJson"
---

<objective>
Use the locally cached style JSON (from Plan 01) when loading offline maps, replacing the broken HTTP URL approach. Add a new `MapStyleResult.OfflineWithLocalStyle` variant and update MapScreen to load it via `Style.Builder().fromJson()`.

Purpose: This is the "read path" for the offline style fix. Plan 01 saves the style JSON during download; this plan loads it when the user views the map offline. Without this, MapLibre still uses `fromUri()` with the HTTP URL, which fails after HTTP cache expires.

Output: Working offline map rendering that survives extended offline periods.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-offline-map-tile-rendering/02.2-RESEARCH.md
@.planning/phases/02.2-offline-map-tile-rendering/02.2-01-SUMMARY.md

Key source files to read before implementation:
@app/src/main/java/com/lxmf/messenger/map/MapTileSourceManager.kt
@app/src/main/java/com/lxmf/messenger/ui/screens/MapScreen.kt
@data/src/main/java/com/lxmf/messenger/data/repository/OfflineMapRegionRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OfflineWithLocalStyle variant and update style resolution</name>
  <files>
    app/src/main/java/com/lxmf/messenger/map/MapTileSourceManager.kt
  </files>
  <action>
    1. Add a new variant to the `MapStyleResult` sealed class:
       ```kotlin
       /**
        * Use offline cached tiles with a locally stored style JSON file.
        * The style JSON was fetched and cached during the offline map download.
        * Uses fromJson() instead of fromUri() to avoid HTTP cache expiration.
        */
       data class OfflineWithLocalStyle(val localStylePath: String) : MapStyleResult()
       ```

    2. Modify the `getMapStyle()` function's `hasOffline` branch to check for a locally cached style JSON first:
       ```kotlin
       hasOffline -> {
           // Check if any completed region has a locally cached style JSON
           val regionWithStyle = offlineMapRegionRepository.getFirstCompletedRegionWithStyle()
           val stylePath = regionWithStyle?.localStylePath

           if (stylePath != null && java.io.File(stylePath).exists()) {
               Log.d(TAG, "Using offline maps with local style JSON: $stylePath")
               MapStyleResult.OfflineWithLocalStyle(stylePath)
           } else {
               // Fallback to HTTP style URL (works if HTTP cache hasn't expired)
               Log.w(TAG, "No local style JSON found, falling back to HTTP style URL")
               MapStyleResult.Offline(DEFAULT_STYLE_URL)
           }
       }
       ```

    3. The `getFirstCompletedRegionWithStyle()` method was added to the repository in Plan 01. Verify it's available by reading the summary from Plan 01.

    **Important:** Do NOT change the `httpEnabled` branch (MapStyleResult.Online) -- that path is correct and should continue using `fromUri()` since the device is online.
  </action>
  <verify>
    Build the app module: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin` succeeds without errors.
  </verify>
  <done>
    - MapStyleResult has OfflineWithLocalStyle variant
    - getMapStyle() checks for local style JSON before falling back to HTTP URL
    - File existence is verified before using local style path
    - Fallback to HTTP URL if no local style exists (backward compatibility)
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle OfflineWithLocalStyle in MapScreen</name>
  <files>
    app/src/main/java/com/lxmf/messenger/ui/screens/MapScreen.kt
  </files>
  <action>
    MapScreen.kt has TWO locations where `when (styleResult)` resolves to a `Style.Builder()`. Both must be updated.

    1. **First location** (~line 329-338, the style update block):
       Find the `when (styleResult)` block that handles style changes. Add the new variant:
       ```kotlin
       is MapStyleResult.OfflineWithLocalStyle -> {
           val styleJson = java.io.File(styleResult.localStylePath).readText()
           Style.Builder().fromJson(styleJson)
       }
       ```
       Place this BETWEEN the existing `is MapStyleResult.Offline` and `is MapStyleResult.Rmsp` cases.

    2. **Second location** (~line 419-434, the initial style loading block):
       Find the second `when (styleResult)` block inside the `mapView.getMapAsync` callback. Add the same handling:
       ```kotlin
       is MapStyleResult.OfflineWithLocalStyle -> {
           val styleJson = java.io.File(styleResult.localStylePath).readText()
           Style.Builder().fromJson(styleJson)
       }
       ```

    3. **Network connectivity**: Both locations have logic to set `MapLibre.setConnected()`. The `OfflineWithLocalStyle` variant should set `allowNetwork = false` (same as `MapStyleResult.Offline`). Update the `allowNetwork` check:
       ```kotlin
       val allowNetwork = styleResult is MapStyleResult.Online || styleResult is MapStyleResult.Rmsp
       ```
       This already works because `OfflineWithLocalStyle` is neither `Online` nor `Rmsp`, so `allowNetwork` will be `false`. Verify this is correct and no explicit check for `OfflineWithLocalStyle` is needed.

    4. Add `import java.io.File` at the top of the file if not already present.

    **Critical:** Use `Style.Builder().fromJson(styleJson)` NOT `Style.Builder().fromUri(filePath)`. The `fromUri()` method expects an HTTP URL and will try to make a network request. `fromJson()` takes a raw JSON string and works entirely offline.
  </action>
  <verify>
    Build the app module: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin` succeeds without errors.
  </verify>
  <done>
    - Both when(styleResult) blocks in MapScreen.kt handle OfflineWithLocalStyle
    - Style JSON is loaded from local file and passed to Style.Builder().fromJson()
    - Network connectivity is disabled for OfflineWithLocalStyle (allowNetwork = false)
    - App module compiles successfully
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Offline map rendering now uses locally cached style JSON instead of relying on HTTP cache. During download (Plan 01), the style JSON is fetched and saved. When viewing offline (this plan), the saved style JSON is loaded via fromJson() instead of fromUri().
  </what-built>
  <how-to-verify>
    1. Install the debug build on a device
    2. Enable HTTP in Settings > Map Sources
    3. Download a new offline map region (any location, any radius)
    4. After download completes, check logcat for: "Cached style JSON for region" message
    5. Disable HTTP in Settings > Map Sources (so only offline maps are used)
    6. Navigate to the Map screen
    7. Check logcat for: "Using offline maps with local style JSON" message
    8. Verify the map shows full vector tile detail (roads, buildings, labels) -- not just continent outlines
    9. (Optional extended test) Leave the device in airplane mode for multiple days, then recheck the map
  </how-to-verify>
  <resume-signal>Type "approved" if offline map renders correctly, or describe what's wrong</resume-signal>
</task>

</tasks>

<verification>
1. `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin` succeeds
2. Run existing tests: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:testDebugUnitTest` passes (no regressions)
3. MapStyleResult sealed class has 5 variants: Online, Offline, OfflineWithLocalStyle, Rmsp, Unavailable
4. MapScreen handles all 5 variants in both when blocks
5. On-device test confirms offline rendering with local style JSON
</verification>

<success_criteria>
- Offline maps render full vector tile detail after extended offline periods
- Style JSON is loaded from local file (not HTTP URL) when offline
- Online mode is completely unaffected
- Existing regions without cached style JSON gracefully degrade to HTTP URL
- No regressions in map functionality (online, RMSP, unavailable states still work)
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-offline-map-tile-rendering/02.2-02-SUMMARY.md`
</output>
