---
phase: 02.3-loading-states-for-tabs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/main/java/com/lxmf/messenger/viewmodel/ChatsViewModel.kt
  - app/src/main/java/com/lxmf/messenger/ui/screens/ChatsScreen.kt
  - app/src/main/java/com/lxmf/messenger/viewmodel/ContactsViewModel.kt
  - app/src/main/java/com/lxmf/messenger/ui/screens/ContactsScreen.kt
autonomous: true

must_haves:
  truths:
    - "User sees 'Loading conversations...' when navigating to Chats tab before data loads"
    - "User sees 'Loading contacts...' when navigating to Contacts tab before data loads"
    - "User does NOT see 'No conversations yet' or 'No contacts yet' while data is still loading"
    - "Empty states only appear when data has finished loading AND is actually empty"
  artifacts:
    - path: "app/src/main/java/com/lxmf/messenger/viewmodel/ChatsViewModel.kt"
      provides: "ChatsState data class with isLoading flag, chatsState StateFlow"
      contains: "data class ChatsState"
    - path: "app/src/main/java/com/lxmf/messenger/ui/screens/ChatsScreen.kt"
      provides: "Loading check before empty state, LoadingConversationsState composable"
      contains: "LoadingConversationsState"
    - path: "app/src/main/java/com/lxmf/messenger/viewmodel/ContactsViewModel.kt"
      provides: "ContactsState data class with isLoading flag"
      contains: "data class ContactsState"
    - path: "app/src/main/java/com/lxmf/messenger/ui/screens/ContactsScreen.kt"
      provides: "Loading check before empty state, LoadingContactsState composable"
      contains: "LoadingContactsState"
  key_links:
    - from: "ChatsScreen.kt"
      to: "ChatsViewModel.kt"
      via: "collectAsState() on chatsState"
      pattern: "viewModel\\.chatsState\\.collectAsState"
    - from: "ContactsScreen.kt"
      to: "ContactsViewModel.kt"
      via: "collectAsState() on contactsState"
      pattern: "state\\.isLoading"
---

<objective>
Add loading states to Chats and Contacts tabs to prevent flashing empty states while data initializes.

Purpose: Fix UX bug (#341) where users see "No conversations yet" or "No contacts yet" flash while data loads from the database, making them think no data exists.

Output: Modified ViewModels with state wrappers containing `isLoading` flag, updated Screens with loading state composables shown before empty states.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.3-loading-states-for-tabs/02.3-RESEARCH.md
@app/src/main/java/com/lxmf/messenger/viewmodel/ChatsViewModel.kt
@app/src/main/java/com/lxmf/messenger/viewmodel/ContactsViewModel.kt
@app/src/main/java/com/lxmf/messenger/ui/screens/ChatsScreen.kt
@app/src/main/java/com/lxmf/messenger/ui/screens/ContactsScreen.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loading states to ChatsViewModel and ChatsScreen</name>
  <files>
    app/src/main/java/com/lxmf/messenger/viewmodel/ChatsViewModel.kt
    app/src/main/java/com/lxmf/messenger/ui/screens/ChatsScreen.kt
  </files>
  <action>
**ChatsViewModel.kt changes:**

1. Add ChatsState data class near the top of the file (after imports, before class):
```kotlin
/**
 * UI state for the Chats tab, including loading status.
 */
data class ChatsState(
    val conversations: List<Conversation> = emptyList(),
    val isLoading: Boolean = true,
)
```

2. Replace the existing `conversations` StateFlow with a new `chatsState` StateFlow:
```kotlin
// Replace this:
val conversations: StateFlow<List<Conversation>> = ...

// With this:
val chatsState: StateFlow<ChatsState> =
    searchQuery
        .flatMapLatest { query ->
            if (query.isBlank()) {
                conversationRepository.getConversations()
            } else {
                conversationRepository.searchConversations(query)
            }
        }
        .map { conversations ->
            ChatsState(
                conversations = conversations,
                isLoading = false,
            )
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000L),
            initialValue = ChatsState(isLoading = true),
        )
```

3. Add import for `map` from kotlinx.coroutines.flow if not already present.

**ChatsScreen.kt changes:**

1. Update state collection at the top of ChatsScreen composable:
```kotlin
// Change from:
val conversations by viewModel.conversations.collectAsState()

// To:
val chatsState by viewModel.chatsState.collectAsState()
```

2. Update subtitle to use chatsState:
```kotlin
subtitle = "${chatsState.conversations.size} ${if (chatsState.conversations.size == 1) "conversation" else "conversations"}"
```

3. Add LoadingConversationsState composable (add near EmptyChatsState):
```kotlin
@Composable
fun LoadingConversationsState(modifier: Modifier = Modifier) {
    Column(
        modifier = modifier,
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center,
    ) {
        CircularProgressIndicator(
            modifier = Modifier.size(48.dp),
        )
        Spacer(modifier = Modifier.height(16.dp))
        Text(
            text = "Loading conversations...",
            style = MaterialTheme.typography.bodyLarge,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
        )
    }
}
```

4. Update the content check inside Scaffold to check loading first:
```kotlin
// Replace this:
if (conversations.isEmpty()) {
    EmptyChatsState(...)
} else {
    LazyColumn(...)
}

// With this:
when {
    chatsState.isLoading -> {
        LoadingConversationsState(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
        )
    }
    chatsState.conversations.isEmpty() -> {
        EmptyChatsState(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
        )
    }
    else -> {
        LazyColumn(...) {
            // Update items() call to use chatsState.conversations
            items(chatsState.conversations, key = { it.peerHash }) { conversation ->
                ...
            }
        }
    }
}
```

5. Update any other references from `conversations` to `chatsState.conversations` in the file.
  </action>
  <verify>
- Build succeeds: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin`
- No lint errors related to ChatsState or chatsState
- ChatsState data class exists with isLoading field
- chatsState StateFlow emits ChatsState with isLoading = true initially
  </verify>
  <done>
- ChatsViewModel exposes chatsState with isLoading flag
- ChatsScreen checks isLoading before showing empty state
- LoadingConversationsState composable shows spinner and "Loading conversations..." text
  </done>
</task>

<task type="auto">
  <name>Task 2: Add loading states to ContactsViewModel and ContactsScreen</name>
  <files>
    app/src/main/java/com/lxmf/messenger/viewmodel/ContactsViewModel.kt
    app/src/main/java/com/lxmf/messenger/ui/screens/ContactsScreen.kt
  </files>
  <action>
**ContactsViewModel.kt changes:**

1. Add ContactsState data class near the top of the file (after existing sealed classes/data classes):
```kotlin
/**
 * UI state for the Contacts tab, including loading status.
 */
data class ContactsState(
    val groupedContacts: ContactGroups = ContactGroups(null, emptyList(), emptyList()),
    val isLoading: Boolean = true,
)
```

2. Replace the existing `groupedContacts` StateFlow with a new `contactsState` StateFlow:
```kotlin
// Replace this:
val groupedContacts: StateFlow<ContactGroups> =
    filteredContacts
        .combine(MutableStateFlow(Unit)) { contacts, _ ->
            ...
        }
        .stateIn(...)

// With this:
val contactsState: StateFlow<ContactsState> =
    filteredContacts
        .map { contacts ->
            val relay = contacts.find { it.isMyRelay }
            Log.d(TAG, "ContactsState: ${contacts.size} filtered, relay=${relay?.displayName}")
            ContactsState(
                groupedContacts = ContactGroups(
                    relay = relay,
                    pinned = contacts.filter { it.isPinned && !it.isMyRelay },
                    all = contacts.filterNot { it.isPinned || it.isMyRelay },
                ),
                isLoading = false,
            )
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000L),
            initialValue = ContactsState(isLoading = true),
        )
```

3. Remove the now-unused `groupedContacts` val if it was the only definition (the old one).

4. Add import for `map` from kotlinx.coroutines.flow if not already present.

**ContactsScreen.kt changes:**

1. Update state collection:
```kotlin
// Change from:
val groupedContacts by viewModel.groupedContacts.collectAsState()

// To:
val contactsState by viewModel.contactsState.collectAsState()
```

2. Add LoadingContactsState composable (add near EmptyContactsState):
```kotlin
@Composable
fun LoadingContactsState(modifier: Modifier = Modifier) {
    Column(
        modifier = modifier,
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center,
    ) {
        CircularProgressIndicator(
            modifier = Modifier.size(48.dp),
        )
        Spacer(modifier = Modifier.height(16.dp))
        Text(
            text = "Loading contacts...",
            style = MaterialTheme.typography.bodyLarge,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
        )
    }
}
```

3. Update the MY_CONTACTS tab content check to check loading first. Find the existing condition:
```kotlin
if (groupedContacts.relay == null && groupedContacts.pinned.isEmpty() && groupedContacts.all.isEmpty()) {
    EmptyContactsState(...)
} else {
    LazyColumn(...)
}
```

Replace with:
```kotlin
when {
    contactsState.isLoading -> {
        LoadingContactsState(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
        )
    }
    contactsState.groupedContacts.relay == null &&
    contactsState.groupedContacts.pinned.isEmpty() &&
    contactsState.groupedContacts.all.isEmpty() -> {
        EmptyContactsState(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
        )
    }
    else -> {
        LazyColumn(...) {
            // Update all references from groupedContacts to contactsState.groupedContacts
            ...
        }
    }
}
```

4. Update all references from `groupedContacts` to `contactsState.groupedContacts` in the file, including:
   - Debug LaunchedEffect logging
   - MY RELAY section (groupedContacts.relay)
   - Pinned section (groupedContacts.pinned)
   - All contacts section (groupedContacts.all, groupedContacts.relay, groupedContacts.pinned)
  </action>
  <verify>
- Build succeeds: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin`
- No lint errors related to ContactsState or contactsState
- ContactsState data class exists with isLoading field
- contactsState StateFlow emits ContactsState with isLoading = true initially
  </verify>
  <done>
- ContactsViewModel exposes contactsState with isLoading flag
- ContactsScreen checks isLoading before showing empty state
- LoadingContactsState composable shows spinner and "Loading contacts..." text
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification:**
   ```bash
   cd /home/tyler/repos/public/columba
   JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin
   ```
   Expected: BUILD SUCCESSFUL

2. **Code verification:**
   - ChatsState and ContactsState data classes exist with isLoading field
   - chatsState and contactsState StateFlows expose the state wrappers
   - ChatsScreen and ContactsScreen check isLoading before showing empty state
   - LoadingConversationsState and LoadingContactsState composables exist

3. **Pattern verification:**
   - Loading state shows CircularProgressIndicator + descriptive text
   - Empty states only appear when isLoading = false AND data is empty
   - Follows MapViewModel boolean flag pattern for consistency
</verification>

<success_criteria>
- Build compiles without errors
- ChatsScreen shows "Loading conversations..." on initial load
- ContactsScreen shows "Loading contacts..." on initial load
- Empty states ("No conversations yet", "No contacts yet") only appear after data loads and is empty
- No regressions in existing functionality (lists display correctly, search works)
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-loading-states-for-tabs/02.3-01-SUMMARY.md`
</output>
