# Phase 02.2: Offline Map Tile Rendering - Research

**Researched:** 2026-01-27
**Domain:** MapLibre Android offline maps, HTTP style caching, local style generation
**Confidence:** HIGH

## Summary

Research into the offline map tile rendering failure after extended offline periods reveals that the app uses **two conflicting offline approaches** that are not properly integrated:

1. **MapLibre OfflineManager API** (primary download mechanism) - Downloads tiles and stores them in `mbgl-offline.db`, expects the style JSON to be cached via HTTP
2. **OfflineMapStyleBuilder** (legacy/unused) - Can generate local style JSON with `mbtiles://` protocol, but **is not wired into the offline code path**

The bug occurs because `MapStyleResult.Offline` returns the same HTTP style URL as online mode (`DEFAULT_STYLE_URL`), relying on MapLibre's internal HTTP cache for the style JSON. After extended offline periods, **MapLibre's HTTP cache for style JSON expires** (respecting HTTP cache headers), leaving the library unable to resolve layer definitions needed to render tiles. The tiles themselves are still present in `mbgl-offline.db`, but without the style JSON, MapLibre falls back to showing only the basic `background` layer (the continent-level outlines the user sees).

**Primary recommendation:** Generate and cache a local style JSON file during offline map download, then load it via `Style.Builder().fromJson()` when in offline mode. This ensures the style definition is available indefinitely without depending on HTTP cache expiration.

## Standard Stack

The codebase uses established libraries for offline map functionality:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| MapLibre Android SDK | 11.5.2 | Vector tile rendering, offline map management | Industry standard open-source map SDK, fork of Mapbox GL Native with active community |
| MapLibre OfflineManager | Built-in | Manages offline region downloads, stores tiles in internal database | Native MapLibre API for offline functionality |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| MBTiles (SQLite format) | Spec 1.3 | Alternative offline tile storage format | When using custom tile sources or legacy code |
| OfflineMapStyleBuilder | Custom | Generates MapLibre style JSON for offline sources | When using `mbtiles://` protocol (not currently used) |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| HTTP style URL + cache | Local style JSON file | Local file never expires, but requires manual generation/bundling |
| OfflineManager API | Pure MBTiles + `mbtiles://` | More manual control, but requires custom protocol handler and style management |
| Single tile source | Hybrid online/offline sources | More complexity, but enables graceful degradation |

**Installation:**
Already integrated. No new dependencies required.

## Architecture Patterns

### Current Code Path (Flawed)

The current offline code path in `MapTileSourceManager.kt`:

```kotlin
// Lines 123-128 in MapTileSourceManager.kt
hasOffline -> {
    // Load the online style URL - MapLibre will serve cached tiles
    // without making network requests for areas covered by offline maps
    Log.d(TAG, "Using offline maps (loading style for cached tile access)")
    MapStyleResult.Offline(DEFAULT_STYLE_URL)
}
```

And in `MapScreen.kt`:

```kotlin
// Lines 331-332
is MapStyleResult.Online -> Style.Builder().fromUri(styleResult.styleUrl)
is MapStyleResult.Offline -> Style.Builder().fromUri(styleResult.styleUrl)
```

**Problem:** Both online and offline modes use `fromUri()` with the same HTTP URL. This works initially because MapLibre caches the style JSON via HTTP, but the cache expires based on HTTP headers. The user's bug report confirms this: after "some days" offline, the map shows only the background layer.

### Recommended Pattern: Local Style JSON with Offline Mode

**Pattern 1: Generate and Cache Style JSON During Download**

When downloading an offline region via MapLibre OfflineManager:

```kotlin
// During download in OfflineMapDownloadViewModel
fun downloadRegion(...) {
    mapLibreOfflineManager.downloadRegion(
        // ... download parameters ...
        onCreated = { regionId ->
            // 1. Fetch the HTTP style JSON once during download
            val styleJson = fetchAndCacheStyleJson(DEFAULT_STYLE_URL)

            // 2. Save it locally for offline use
            val styleFile = File(context.filesDir, "offline_styles/$regionId.json")
            styleFile.writeText(styleJson)

            // 3. Store the local path in the database
            offlineMapRegionRepository.updateStylePath(regionId, styleFile.absolutePath)
        }
    )
}
```

**Pattern 2: Load Local Style JSON When Offline**

Modify `MapTileSourceManager.kt` to return the local style path:

```kotlin
hasOffline -> {
    // Get the first completed region (or region covering current location)
    val region = offlineMapRegionRepository.getCompletedRegions().first().firstOrNull()
    val stylePath = region?.localStylePath

    if (stylePath != null && File(stylePath).exists()) {
        Log.d(TAG, "Using offline maps with local style JSON")
        MapStyleResult.OfflineWithLocalStyle(stylePath)
    } else {
        // Fallback to HTTP style if no local style available
        Log.w(TAG, "No local style found, falling back to HTTP URL")
        MapStyleResult.Offline(DEFAULT_STYLE_URL)
    }
}
```

And update `MapScreen.kt` to handle the new result type:

```kotlin
when (styleResult) {
    is MapStyleResult.Online -> Style.Builder().fromUri(styleResult.styleUrl)
    is MapStyleResult.OfflineWithLocalStyle -> {
        val styleJson = File(styleResult.localStylePath).readText()
        Style.Builder().fromJson(styleJson)
    }
    is MapStyleResult.Offline -> Style.Builder().fromUri(styleResult.styleUrl) // fallback
}
```

### Alternative Pattern: Bundle Style JSON in Assets

For simpler implementation, bundle a copy of the style JSON in the app's assets directory:

```kotlin
// In MapTileSourceManager.kt
hasOffline -> {
    // Use bundled style JSON from assets
    MapStyleResult.OfflineWithAssetStyle("offline_map_style.json")
}

// In MapScreen.kt
is MapStyleResult.OfflineWithAssetStyle -> {
    val styleJson = context.assets.open(styleResult.assetPath).bufferedReader().use { it.readText() }
    Style.Builder().fromJson(styleJson)
}
```

This approach is simpler but requires updating the bundled style manually when the tile source changes.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Style JSON caching | Custom cache with expiration logic | Local file storage with JSON serialization | HTTP cache expiration is the root cause; avoid relying on it |
| MBTiles generation | Custom tile packer | MapLibre OfflineManager API | Already handles tile downloads, deduplication, and storage efficiently |
| Offline region management | Custom region database | OfflineMapRegionRepository + OfflineManager | Already tracks regions, status, and provides Room-based querying |
| Style JSON fetching | Manual HTTP requests | OkHttp/Retrofit with single-shot call | Already in the project, handles retries and errors properly |

**Key insight:** The existing `OfflineMapStyleBuilder.kt` can generate style JSON, but it's designed for `mbtiles://` protocol sources (lines 142-143). The current OfflineManager approach stores tiles in MapLibre's internal database, which are served automatically when the style references themâ€”no `mbtiles://` needed. The issue is the style JSON itself not being available offline, not the tile storage mechanism.

## Common Pitfalls

### Pitfall 1: Assuming MapLibre Caches Style JSON Forever
**What goes wrong:** The app loads the HTTP style URL in offline mode, expecting MapLibre to serve it from cache indefinitely.

**Why it happens:** MapLibre respects HTTP cache headers (Expires, Cache-Control, max-age). The OpenFreeMap Liberty style likely has cache headers that expire after days/weeks.

**How to avoid:** Store the style JSON locally as a file, bypassing HTTP cache expiration entirely. Generate and save it during the initial offline map download.

**Warning signs:** User reports map working initially after download, then failing after "some days" offline. Logs show "Applying style: g" (ProGuard-obfuscated) and "Creating new source and layers with 0 features", indicating the style loaded but has no tile sources defined.

### Pitfall 2: Using `Style.Builder().fromUri()` for Offline Styles
**What goes wrong:** The code uses the same `fromUri()` method for both online and offline modes, which always makes a network request (or checks HTTP cache).

**Why it happens:** Misunderstanding of MapLibre's style loading: `fromUri()` is for HTTP/HTTPS URLs, `fromJson()` is for local JSON strings.

**How to avoid:** Use `Style.Builder().fromJson(styleJsonString)` when loading offline styles. The JSON string can be read from a local file or embedded in assets.

**Warning signs:** Network logs show HTTP requests for style JSON even when `MapLibre.setConnected(false)` is called. The app relies on HTTP cache fallback instead of truly offline loading.

### Pitfall 3: Not Testing Extended Offline Periods
**What goes wrong:** Offline maps work immediately after download but fail after days/weeks offline.

**Why it happens:** HTTP cache headers are time-based. Testing immediately after download doesn't reveal expiration issues.

**How to avoid:**
1. Test with device in airplane mode for multiple days
2. Manually clear MapLibre's ambient cache: `OfflineManager.getInstance(context).clearAmbientCache()`
3. Verify style JSON is served from local file, not HTTP cache

**Warning signs:** Issue only appears after "some offline days" as reported in #354. Short-term offline testing passes but long-term fails.

### Pitfall 4: Confusing Two Offline Approaches
**What goes wrong:** The codebase has both OfflineManager (used) and OfflineMapStyleBuilder (unused), leading to confusion about which approach to use.

**Why it happens:** Legacy code from exploring MBTiles approach was kept but not integrated.

**How to avoid:** Document which approach is primary. If using OfflineManager, clearly note that `OfflineMapStyleBuilder` is for alternative MBTiles workflow, not the active code path.

**Warning signs:** Comments in code (line 113-116 in MapTileSourceManager.kt) explain OfflineManager reliance on cached style, but don't mention the expiration risk or local style generation as a solution.

## Code Examples

Verified patterns from MapLibre documentation and existing codebase:

### Loading Style from JSON String (MapLibre Android)
```kotlin
// Source: MapLibre Native documentation + Columba MapScreen.kt line 337
val emptyStyleJson = """
{
    "version": 8,
    "name": "Empty",
    "sources": {},
    "layers": [
        {
            "id": "background",
            "type": "background",
            "paint": {
                "background-color": "#f0f0f0"
            }
        }
    ]
}
"""
map.setStyle(Style.Builder().fromJson(emptyStyleJson)) { style ->
    // Style loaded from JSON string, no HTTP request
}
```

### Fetching and Caching Style JSON During Download
```kotlin
// Source: Adapted from MapLibre OfflineManager patterns
suspend fun fetchStyleJsonOnce(styleUrl: String): String {
    return withContext(Dispatchers.IO) {
        val client = OkHttpClient()
        val request = Request.Builder().url(styleUrl).build()
        client.newCall(request).execute().use { response ->
            if (!response.isSuccessful) throw IOException("Failed to fetch style: $response")
            response.body?.string() ?: throw IOException("Empty style response")
        }
    }
}

// During offline region download
fun downloadRegion(...) {
    mapLibreOfflineManager.downloadRegion(
        onCreated = { regionId ->
            viewModelScope.launch {
                try {
                    // Fetch style JSON once during download (while online)
                    val styleJson = fetchStyleJsonOnce(DEFAULT_STYLE_URL)

                    // Save to local file
                    val styleFile = File(context.filesDir, "offline_styles/${regionId}.json")
                    styleFile.parentFile?.mkdirs()
                    styleFile.writeText(styleJson)

                    // Store path in database for retrieval
                    offlineMapRegionRepository.updateLocalStylePath(regionId, styleFile.absolutePath)

                    Log.d(TAG, "Cached style JSON for region $regionId at ${styleFile.absolutePath}")
                } catch (e: Exception) {
                    Log.e(TAG, "Failed to cache style JSON", e)
                    // Non-fatal - tile download continues, fallback to HTTP cache
                }
            }
        }
    )
}
```

### Database Schema Addition for Local Style Path
```kotlin
// Add to OfflineMapRegionEntity.kt
@Entity(tableName = "offline_map_regions")
data class OfflineMapRegionEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val name: String,
    val mapLibreRegionId: Long?,
    // ... existing fields ...

    // NEW: Path to locally cached style JSON
    val localStylePath: String? = null,
)
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Load style from HTTP URL in offline mode | Still using HTTP URL (bug) | N/A | Relies on HTTP cache expiration, fails after days offline |
| MBTiles with `mbtiles://` protocol | MapLibre OfflineManager API | Before v0.6 | Simpler integration, but requires style JSON caching solution |
| No offline style caching | (Not yet implemented) | Target: v0.7.2 Phase 2.2 | Will enable indefinite offline rendering |

**Deprecated/outdated:**
- **MBTiles approach with OfflineMapStyleBuilder**: The code exists (OfflineMapStyleBuilder.kt lines 127-153) but is not used in the active code path. MapLibre OfflineManager is the current standard. The MBTiles approach would require custom protocol handlers and is more complex.

**Current standard (as of MapLibre Android 11.5.2):**
- Use **OfflineManager API** for tile downloads (automatic caching, progress tracking)
- Store tiles in `mbgl-offline.db` (MapLibre's internal database)
- Load style JSON from **local file or bundled assets** in offline mode (not HTTP URL)

## Open Questions

1. **HTTP cache duration for OpenFreeMap Liberty style**
   - What we know: The style is fetched from `https://tiles.openfreemap.org/styles/liberty`, and user reports failure after "some days" offline
   - What's unclear: Exact cache expiration time (could be 7 days, 30 days, or longer). This would help set user expectations.
   - Recommendation: Test with actual HTTP headers from OpenFreeMap, or assume worst-case (7 days) and implement local caching regardless

2. **Multiple offline regions with different styles**
   - What we know: The app can download multiple offline regions
   - What's unclear: Should each region have its own style JSON, or share one global style? Current code returns first region regardless of location.
   - Recommendation: Use a single shared style file for all regions (since all use the same tile source). Store it at a global path, not per-region.

3. **Style JSON versioning and updates**
   - What we know: The app downloads tiles for a specific style version
   - What's unclear: What happens if the remote style JSON is updated (new layers, different colors)? Should the app check for updates?
   - Recommendation: For v0.7.2, use a static cached style. Future enhancement could check style version and prompt user to re-download if changed.

## Sources

### Primary (HIGH confidence)
- Columba codebase analysis (MapTileSourceManager.kt, MapScreen.kt, MapLibreOfflineManager.kt, OfflineMapStyleBuilder.kt)
- [MapLibre Native GitHub Repository](https://github.com/maplibre/maplibre-native) - Official documentation and examples
- [MapLibre Android API Documentation](https://maplibre.org/maplibre-native/android/api/-map-libre%20-native%20-android/org.maplibre.android.offline/-offline-manager/index.html) - OfflineManager methods
- GitHub Issue #354 - User bug report with logs confirming extended offline failure
- MapLibre Android SDK 11.5.2 dependency (app/build.gradle.kts)

### Secondary (MEDIUM confidence)
- [MapLibre Caching Documentation](https://maplibre.org/maplibre-rs/book/development-documents/caching.html) - HTTP cache behavior
- [Offline Maps with Flutter MapLibre GL - Stadia Maps](https://docs.stadiamaps.com/tutorials/offline-maps-with-flutter-maplibre-gl/) - Cross-platform offline patterns
- [GitHub Issue #2300 - setMaximumAmbientCacheAge](https://github.com/maplibre/maplibre-native/issues/2300) - Discussion of age-based cache expiration limitations

### Key Finding from Sources
From MapLibre caching documentation: "You must observe HTTP cache headers and attempt to revalidate expired cache entries whenever possible, though you may serve stale tiles if the device is offline."

This confirms that **MapLibre respects HTTP cache expiration** even for offline resources. The app's reliance on HTTP-cached style JSON is the root cause of the bug.

## Metadata

**Confidence breakdown:**
- Standard stack: **HIGH** - Using established MapLibre OfflineManager API (v11.5.2) with extensive documentation
- Architecture: **HIGH** - Root cause identified via code analysis and user logs; solution pattern verified in MapLibre examples
- Pitfalls: **HIGH** - All pitfalls confirmed by analyzing issue #354 logs and HTTP cache behavior

**Research date:** 2026-01-27
**Valid until:** 30 days (MapLibre API is stable; caching behavior unlikely to change)

**Critical insights for planning:**
1. The fix requires database schema addition (localStylePath column in OfflineMapRegionEntity)
2. Must fetch and store style JSON during offline map download (while still online)
3. Must modify MapScreen.kt to use `fromJson()` instead of `fromUri()` for offline styles
4. Breaking change: Existing offline regions downloaded before this fix won't have cached style JSON (will continue to fail after cache expires)
5. Non-breaking: Can implement this fix without affecting online mode or users without offline maps
