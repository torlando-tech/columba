---
phase: 02.1-clear-announces-preserves-contacts
plan: 02
subsystem: testing
tags: [room, robolectric, mockk, unit-tests, dao, viewmodel]

# Dependency graph
requires:
  - phase: 02.1-01
    provides: SQL subquery deleteAllAnnouncesExceptContacts implementation
provides:
  - Comprehensive test coverage for contact-preserving announce deletion
  - DAO tests using in-memory Room database (Robolectric)
  - ViewModel tests using MockK for identity-aware routing
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "DAO tests use real in-memory Room database for SQL validation"
    - "ViewModel tests use MockK to verify repository method calls"
    - "Test helper functions for creating test entities with FK constraints"

key-files:
  created: []
  modified:
    - data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt
    - app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt

key-decisions:
  - "Use in-memory Room database (not mocks) for DAO tests to validate actual SQL behavior"
  - "Insert LocalIdentityEntity before ContactEntity to satisfy FK constraints"
  - "Test identity scoping to ensure contacts from other identities don't prevent deletion"

patterns-established:
  - "DAO tests execute real SQL against in-memory database for query validation"
  - "Helper functions create test entities respecting database constraints"

# Metrics
duration: 5m 14s
completed: 2026-01-28
---

# Phase 02.1 Plan 02: Test Contact-Preserving Deletion Summary

**Comprehensive unit tests validate SQL subquery preserves contact announces and deletes non-contacts across edge cases using real Room database and MockK**

## Performance

- **Duration:** 5m 14s
- **Started:** 2026-01-28T02:41:54Z
- **Completed:** 2026-01-28T02:47:08Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- 6 new DAO tests using Robolectric in-memory Room database validate SQL query behavior
- 3 ViewModel tests (2 updated, 1 new) verify identity-aware delete routing with MockK
- All tests execute production code (no mock-only tests)
- Full test suite passes with zero failures

## Task Commits

Each task was committed atomically:

1. **Task 1: Add DAO tests for deleteAllAnnouncesExceptContacts** - `099fbea` (test)
2. **Task 2: Add ViewModel tests for identity-aware delete routing** - `102380b` (test)

## Files Created/Modified
- `data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt` - Added 6 tests for SQL subquery behavior, helper functions for test entities with FK constraints
- `app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt` - Updated 2 tests, added 1 new test for identity-aware delete routing

## Decisions Made

**1. Use real Room database for DAO tests (not mocks)**
- Rationale: Validates actual SQL query execution, catches Room-specific bugs
- Approach: Robolectric in-memory database with real DAO methods

**2. Test identity scoping explicitly**
- Rationale: Critical that contacts from other identities don't prevent deletion
- Coverage: Dedicated test verifies identity_A has no contacts â†’ all announces deleted

**3. Insert LocalIdentityEntity before ContactEntity**
- Rationale: ContactEntity has FK constraint on identityHash
- Solution: Helper function createTestIdentity() called before createTestContact()

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Minor: Linter removed imports during first edit**
- Problem: ContactEntity and LocalIdentityEntity imports removed by auto-formatter
- Resolution: Re-added imports, verified compilation

**Minor: Wrong DAO method name initially**
- Problem: Used `insertIdentity()` instead of `insert()`
- Resolution: Checked LocalIdentityDao source, corrected to `insert()`

**Minor: App module has multiple test variants**
- Problem: `testDebugUnitTest` is ambiguous (noSentry vs sentry variants)
- Resolution: Used `testNoSentryDebugUnitTest` explicitly

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for production merge:**
- All tests pass (DAO + ViewModel)
- Full test suite passes
- Detekt code quality checks pass
- SQL query behavior validated with real Room database
- Identity-aware routing verified with MockK

**Coverage validates:**
- Contact announces preserved for active identity
- Non-contact announces deleted
- Contacts from other identities ignored (identity scoping)
- Empty contacts table results in full deletion
- Null identity fallback to original deleteAllAnnounces()
- Original deleteAllAnnounces() still deletes everything (regression test)

**No blockers for Phase 2.1 completion.**

---
*Phase: 02.1-clear-announces-preserves-contacts*
*Completed: 2026-01-28*
