---
phase: 11-telephony-integration
plan: 03
type: execute
wave: 3
depends_on: ["11-01", "11-02"]
files_modified:
  - reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt
autonomous: true

must_haves:
  truths:
    - "Dial tone plays during outgoing call setup"
    - "Dial tone stops when remote starts ringing"
    - "Busy tone plays when remote is busy or rejects"
    - "Ringtone plays for incoming calls"
  artifacts:
    - path: "reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt"
      provides: "Audio feedback methods in Telephone class"
      contains: ["activateDialTone", "disableDialTone", "playBusyTone", "activateRingTone"]
  key_links:
    - from: "Telephone.kt"
      to: "ToneSource"
      via: "dialTone property"
      pattern: "dialTone.*ToneSource"
    - from: "Telephone.kt"
      to: "receiveMixer"
      via: "dialTone.sink = receiveMixer"
      pattern: "dialTone\\??\\.sink.*receiveMixer"
---

<objective>
Add audio feedback functionality to Telephone class: dial tone, busy tone, and ringtone.

Purpose: Audio feedback provides user awareness of call state. Dial tone during outgoing call, busy tone when remote unavailable, ringtone on incoming calls.

Output:
- Updated Telephone.kt with complete audio feedback implementation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-telephony-integration/11-RESEARCH.md
@.planning/phases/11-telephony-integration/11-CONTEXT.md

# Prior plan - Profile and NetworkTransport
@.planning/phases/11-telephony-integration/11-01-SUMMARY.md

# Prior plan - Telephone core (creates Telephone.kt)
@.planning/phases/11-telephony-integration/11-02-SUMMARY.md

# Reference files
@reticulum/src/main/java/com/lxmf/messenger/reticulum/audio/lxst/ToneSource.kt
@reticulum/src/main/java/com/lxmf/messenger/reticulum/audio/lxst/Mixer.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dial tone and busy tone to Telephone</name>
  <files>reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt</files>
  <action>
This task adds audio feedback methods to the Telephone class created in Plan 02. If Plan 02 hasn't been executed yet, this task creates the audio feedback portion as stubs that Plan 02 will integrate.

Add companion constants matching Python LXST Telephony.py (lines 118-119, 172):

```kotlin
companion object {
    // ... existing constants ...
    const val DIAL_TONE_FREQUENCY = 382f  // Hz, matches Python LXST
    const val DIAL_TONE_EASE_MS = 3.14159f
    const val DIAL_TONE_GAIN = 0.04f
    const val BUSY_TONE_SECONDS = 4.25f
}
```

Add property:
```kotlin
private var dialTone: ToneSource? = null
```

**Implement audio feedback methods:**

1. `private fun enableDialTone()`:
   Match Python Telephony.py lines 565-568:
   - Ensure receiveMixer is running (start if not)
   - Set dialTone.gain = DIAL_TONE_GAIN
   - Start dialTone if not running

2. `private fun muteDialTone()`:
   Match Python Telephony.py lines 570-573:
   - Ensure receiveMixer is running
   - Set dialTone.gain = 0.0 (silence but keep running)
   - Start dialTone if not running

3. `private fun disableDialTone()`:
   Match Python Telephony.py lines 575-577:
   - Stop dialTone if running

4. `private fun activateDialTone()`:
   Match Python Telephony.py lines 553-563. Run in background coroutine:
   ```kotlin
   private fun activateDialTone() {
       scope.launch {
           val window = 7_000L  // 7 second cycle
           val started = System.currentTimeMillis()
           while (activeCall && isOutgoingCall && callStatus == Signalling.STATUS_RINGING) {
               val elapsed = (System.currentTimeMillis() - started) % window
               if (elapsed > 50 && elapsed < 2050) {
                   enableDialTone()
               } else {
                   muteDialTone()
               }
               delay(200)
           }
       }
   }
   ```
   This creates the distinctive dial-ring-dial pattern (2 seconds on, 5 seconds off).

5. `private suspend fun playBusyTone()`:
   Match Python Telephony.py lines 541-551:
   ```kotlin
   private suspend fun playBusyTone() {
       if (busyToneSeconds <= 0) return
       if (audioOutput == null || receiveMixer == null || dialTone == null) {
           resetDiallingPipelines()
       }

       val windowMs = 500L
       val started = System.currentTimeMillis()
       while (System.currentTimeMillis() - started < BUSY_TONE_SECONDS * 1000) {
           val elapsed = (System.currentTimeMillis() - started) % windowMs
           if (elapsed > 250) {
               enableDialTone()
           } else {
               muteDialTone()
           }
           delay(5)
       }
       delay(500)  // Final silence
   }
   ```
   This creates the distinctive busy pattern (0.25s on, 0.25s off).

**Update prepareDiallingPipelines()** to create dial tone:
```kotlin
private fun prepareDiallingPipelines() {
    selectCallProfile(activeProfile)
    if (audioOutput == null) {
        audioOutput = LineSink(audioBridge)
    }
    if (receiveMixer == null) {
        receiveMixer = Mixer(targetFrameMs = activeProfile.frameTimeMs)
        receiveMixer?.sink = audioOutput
    }
    if (dialTone == null) {
        dialTone = ToneSource(
            frequency = DIAL_TONE_FREQUENCY,
            targetGain = 0f,  // Start silent
            ease = true,
            easeTimeMs = DIAL_TONE_EASE_MS,
            targetFrameMs = activeProfile.frameTimeMs
        )
        dialTone?.sink = receiveMixer
    }
}
```

**Update signal handling** to trigger dial tone on STATUS_RINGING for outgoing calls:
```kotlin
Signalling.STATUS_RINGING -> {
    callStatus = signal
    prepareDiallingPipelines()
    signalProfilePreference()
    if (isOutgoingCall) {
        activateDialTone()
    }
}
```

**Update STATUS_ESTABLISHED handling** to stop dial tone:
```kotlin
Signalling.STATUS_ESTABLISHED -> {
    disableDialTone()
    startPipelines()
    callStatus = signal
    callBridge.onCallEstablished(currentRemoteIdentity)
}
```
  </action>
  <verify>
File compiles:
```bash
cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin 2>&1 | head -50
```
  </verify>
  <done>
Telephone.kt has dial tone and busy tone functionality:
- enableDialTone(), muteDialTone(), disableDialTone() methods
- activateDialTone() with 2s on / 5s off pattern
- playBusyTone() with 0.25s on / 0.25s off pattern
- Dial tone stops on STATUS_ESTABLISHED
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ringtone support for incoming calls</name>
  <files>reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt</files>
  <action>
Add ringtone support for incoming calls per CONTEXT.md decision: "Ringtone: User setting - can choose system ringtone OR custom ToneSource tone".

**Add properties:**
```kotlin
// Ringtone configuration (set via setRingtone())
private var useSystemRingtone: Boolean = true
private var customRingtonePath: String? = null
private var systemRingtone: Ringtone? = null
private var ringerMixer: Mixer? = null
private var ringerSink: LineSink? = null
private var ringTone: ToneSource? = null
```

**Add configuration methods:**

1. `fun setRingtone(path: String?)`:
   - If path is null, use system ringtone (default)
   - If path provided, use ToneSource ring pattern

2. `fun setUseSystemRingtone(use: Boolean)`:
   - Toggle between system ringtone and tone pattern

**Implement activateRingTone()** (match Python Telephony.py lines 526-539):

For system ringtone (default Android behavior):
```kotlin
private fun activateRingTone() {
    if (useSystemRingtone) {
        // Use Android RingtoneManager
        scope.launch(Dispatchers.Main) {
            try {
                val uri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_RINGTONE)
                systemRingtone = RingtoneManager.getRingtone(context, uri)
                systemRingtone?.play()
            } catch (e: Exception) {
                Log.w(TAG, "Failed to play system ringtone, using fallback tone")
                playToneRingPattern()
            }
        }
    } else {
        // Use ToneSource pattern
        playToneRingPattern()
    }
}
```

For tone pattern fallback:
```kotlin
private fun playToneRingPattern() {
    scope.launch {
        // Create ringer pipeline if needed
        if (ringerSink == null) {
            ringerSink = LineSink(audioBridge)
            ringerMixer = Mixer(targetFrameMs = 60)
            ringerMixer?.sink = ringerSink
            ringTone = ToneSource(
                frequency = DIAL_TONE_FREQUENCY,
                targetGain = 0.1f,
                ease = true
            )
            ringTone?.sink = ringerMixer
        }

        // Ring pattern: 2s on, 4s off (standard telephone ring)
        while (isIncomingCall && callStatus == Signalling.STATUS_RINGING) {
            ringerMixer?.start()
            ringTone?.start()
            delay(2000)
            ringTone?.stop()
            delay(4000)
        }

        // Cleanup
        ringTone?.stop()
        ringerMixer?.stop()
    }
}
```

**Implement stopRingTone():**
```kotlin
private fun stopRingTone() {
    systemRingtone?.stop()
    systemRingtone = null
    ringTone?.stop()
    ringerMixer?.stop()
}
```

**Wire into signal handling:**

On incoming call ringing (in caller identified callback or wherever ringing starts):
```kotlin
if (isIncomingCall) {
    activateRingTone()
}
```

On answer() or hangup():
```kotlin
stopRingTone()
```

**Note on Context:** If audioBridge doesn't provide Application Context, the Telephone constructor may need to accept a Context parameter for RingtoneManager. Check existing pattern in KotlinAudioBridge.
  </action>
  <verify>
File compiles:
```bash
cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin 2>&1 | head -50
```
  </verify>
  <done>
Telephone.kt has ringtone support:
- System ringtone as default
- ToneSource fallback pattern
- Ringtone stops on answer or hangup
  </done>
</task>

</tasks>

<verification>
Telephone compiles with audio feedback:
```bash
cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin --info 2>&1 | grep -E "(BUILD|error)"
```

Verify dial tone uses correct frequency:
```bash
grep "DIAL_TONE_FREQUENCY.*382" /home/tyler/repos/public/columba/reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt
```
</verification>

<success_criteria>
1. Dial tone pattern plays during outgoing call setup (2s on, 5s off)
2. Dial tone stops on STATUS_RINGING or STATUS_ESTABLISHED
3. Busy tone pattern plays when remote busy/rejected (0.25s on, 0.25s off)
4. Ringtone plays for incoming calls (system or fallback)
5. All tones stop on answer() or hangup()
6. No compile errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-telephony-integration/11-03-SUMMARY.md`
</output>
