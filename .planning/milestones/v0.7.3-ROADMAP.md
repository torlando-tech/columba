# Milestone v0.7.3: Bug Fixes

**Status:** ✅ SHIPPED 2026-01-28
**Phases:** 1-2.3
**Total Plans:** 11

## Overview

This milestone addressed high-priority bugs reported after the 0.7.2 pre-release: performance degradation (#340), relay auto-selection loop (#343), plus three urgent insertions for clear announces (#365), offline maps (#354), and loading states (#341).

## Phases

### Phase 1: Performance Fix

**Goal**: App runs smoothly without progressive degradation, especially on Interface Discovery screen
**Depends on**: Nothing (first phase)
**Requirements**: PERF-01, PERF-02, PERF-03
**Success Criteria** (what must be TRUE):
  1. User can scroll Interface Discovery screen without visible stuttering or lag
  2. User can leave app running for extended periods (30+ minutes) without UI responsiveness degrading
  3. User can interact with buttons and UI elements with immediate (<200ms) response
  4. Memory usage remains stable over time (no unbounded growth visible in profiler)
**Plans**: 3 plans in 2 waves

Plans:
- [x] 01-01-PLAN.md - Setup & Investigation (LeakCanary + profiling session + FINDINGS.md)
- [x] 01-02-PLAN.md - Apply fixes based on findings + verification profiling
- [x] 01-03-PLAN.md - Add Sentry performance monitoring for ongoing observability

### Phase 2: Relay Loop Fix

**Goal**: Relay auto-selection works correctly without add/remove cycling
**Depends on**: Nothing (independent of Phase 1)
**Requirements**: RELAY-01, RELAY-02
**Success Criteria** (what must be TRUE):
  1. User sees relay selected once and it stays selected (no repeated add/remove in logs)
  2. User can manually unset relay, and system re-selects a relay exactly once (not in a loop)
  3. Relay selection logs show clean single-selection behavior, not 40+ cycles
**Plans**: 3 plans in 2 waves

Plans:
- [x] 02-01-PLAN.md - Add state machine to PropagationNodeManager (IDLE/SELECTING/STABLE)
- [x] 02-02-PLAN.md - Add loop detection, backoff, and Sentry diagnostics (depends on 02-01)
- [x] 02-03-PLAN.md - Add unit tests for state machine (depends on 02-01)

### Phase 2.1: Clear Announces Preserves Contacts (INSERTED)

**Goal**: "Clear All Announces" in the Network tab deletes all announces *except* those belonging to contacts in My Contacts, preserving the ability to open new conversations with saved contacts
**Depends on**: Nothing (independent fix)
**Requirements**: ANNOUNCE-01
**Issue**: [#365](https://github.com/torlando-tech/columba/issues/365)
**Success Criteria** (what must be TRUE):
  1. User can tap "Clear All Announces" and all non-contact announces are removed
  2. Announces belonging to contacts in My Contacts are preserved after clearing
  3. User can still open a new conversation with any saved contact after clearing announces
  4. "Node not found" error no longer appears when tapping a contact after clearing announces
**Plans**: 2 plans in 2 waves

Plans:
- [x] 02.1-01-PLAN.md — Fix DAO, Repository, ViewModel, and UI to preserve contact announces
- [x] 02.1-02-PLAN.md — Add DAO and ViewModel tests for contact-preserving deletion (depends on 02.1-01)

### Phase 2.2: Offline Map Tile Rendering (INSERTED)

**Goal**: Offline maps that were previously downloaded render correctly after extended offline periods, ensuring the offline code path explicitly uses local tile data without depending on network-fetched style resources
**Depends on**: Nothing (independent fix)
**Requirements**: OFFLINE-MAP-01
**Issue**: [#354](https://github.com/torlando-tech/columba/issues/354)
**Success Criteria** (what must be TRUE):
  1. User can download offline map tiles, go fully offline for multiple days, and still see their downloaded tiles render correctly
  2. The offline style loading path explicitly serves tiles from the local cache/MBTiles without relying on a network-fetched style URL
  3. Zooming into a region covered by downloaded offline tiles shows full vector tile detail (roads, buildings, labels), not just continent-level outlines
  4. The offline map region list correctly reflects available regions and their tiles are accessible
**Plans**: 2 plans in 2 waves

Plans:
- [x] 02.2-01-PLAN.md — Add localStylePath to DB schema and cache style JSON during download
- [x] 02.2-02-PLAN.md — Load local style JSON when offline and update MapScreen (depends on 02.2-01)

### Phase 2.3: Loading States for Tabs (INSERTED)

**Goal**: Show loading indicators while data initializes instead of flashing empty states ("No conversations yet", "No contacts yet") that confuse users into thinking no data exists
**Depends on**: Nothing (independent fix)
**Requirements**: UX-LOADING-01
**Issue**: [#341](https://github.com/torlando-tech/columba/issues/341)
**Success Criteria** (what must be TRUE):
  1. User sees "Loading conversations..." when navigating to Chats tab before data loads
  2. User sees "Loading contacts..." when navigating to Contacts tab before data loads
  3. User does NOT see "No conversations yet" or "No contacts yet" while data is still loading
  4. After Skip on onboarding, user sees loading state (not empty state) until data loads
  5. Empty states only appear when data has finished loading AND is actually empty
**Plans**: 1 plan in 1 wave

Plans:
- [x] 02.3-01-PLAN.md — Add loading states to ChatsViewModel/Screen and ContactsViewModel/Screen

---

## Milestone Summary

**Decimal Phases:**
- Phase 2.1: Clear Announces Preserves Contacts (inserted for urgent #365 fix)
- Phase 2.2: Offline Map Tile Rendering (inserted for urgent #354 fix)
- Phase 2.3: Loading States for Tabs (inserted for urgent #341 fix)

**Key Decisions:**
- Focus on #340 (performance) and #343 (relay loop) first — highest user impact
- Add Compose runtime dependency to data module for @Stable annotation
- Use 1000ms debounce to batch rapid Room invalidation triggers
- Use 30-second cooldown after successful relay selection
- 3+ selections in 60 seconds triggers loop detection warning
- Exponential backoff: 2^(count-3) seconds, capped at 10 minutes
- Use SQL subquery (NOT IN) for contact-aware filtering instead of joins
- Use fromJson() instead of fromUri() for local style files
- Use boolean isLoading flag pattern (consistent with MapViewModel)

**Issues Resolved:**
- #340: Bad stuttering with Interface Discovery, app gets slower over time
- #343: MY RELAY auto-selection loop (40+ add/remove cycles)
- #365: Clear All Announces deletes contact announces
- #354: Offline maps stop rendering after extended offline period
- #341: Empty state flashes while data loads

**Issues Deferred:**
- #338: Duplicate notifications after service restart
- #342: Location permission dialog regression
- Native memory growth (~1.4 MB/min in Python layer) — needs upstream investigation

**Technical Debt Incurred:**
- PropagationNodeManager is large class (LargeClass suppressed) — extract RelaySelectionStateMachine
- Native memory growth in Python/Reticulum layer needs tracemalloc investigation

---

_For current project status, see .planning/ROADMAP.md_
