---
phase: 02.2-offline-map-tile-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - data/src/main/java/com/lxmf/messenger/data/db/entity/OfflineMapRegionEntity.kt
  - data/src/main/java/com/lxmf/messenger/data/db/ColumbaDatabase.kt
  - data/src/main/java/com/lxmf/messenger/data/di/DatabaseModule.kt
  - data/src/main/java/com/lxmf/messenger/data/db/dao/OfflineMapRegionDao.kt
  - data/src/main/java/com/lxmf/messenger/data/repository/OfflineMapRegionRepository.kt
  - app/src/main/java/com/lxmf/messenger/viewmodel/OfflineMapDownloadViewModel.kt
autonomous: true

must_haves:
  truths:
    - "Style JSON is fetched from the HTTP style URL and saved to a local file during offline map download"
    - "The local style file path is stored in the database via the new localStylePath column"
    - "The OfflineMapRegion domain model exposes the localStylePath field"
    - "Database migration 34->35 adds the localStylePath column without data loss"
  artifacts:
    - path: "data/src/main/java/com/lxmf/messenger/data/db/entity/OfflineMapRegionEntity.kt"
      provides: "localStylePath column on OfflineMapRegionEntity"
      contains: "localStylePath"
    - path: "data/src/main/java/com/lxmf/messenger/data/di/DatabaseModule.kt"
      provides: "Migration 34->35 adding localStylePath column"
      contains: "MIGRATION_34_35"
    - path: "data/src/main/java/com/lxmf/messenger/data/db/dao/OfflineMapRegionDao.kt"
      provides: "DAO method to update localStylePath"
      contains: "updateLocalStylePath"
    - path: "data/src/main/java/com/lxmf/messenger/data/repository/OfflineMapRegionRepository.kt"
      provides: "Repository method to update localStylePath"
      contains: "updateLocalStylePath"
    - path: "app/src/main/java/com/lxmf/messenger/viewmodel/OfflineMapDownloadViewModel.kt"
      provides: "Style JSON fetching and caching during download"
      contains: "fetchAndCacheStyleJson"
  key_links:
    - from: "OfflineMapDownloadViewModel.kt"
      to: "OfflineMapRegionRepository.kt"
      via: "updateLocalStylePath call after caching style JSON"
      pattern: "updateLocalStylePath"
    - from: "OfflineMapRegionRepository.kt"
      to: "OfflineMapRegionDao.kt"
      via: "DAO delegation for updateLocalStylePath"
      pattern: "offlineMapRegionDao\\.updateLocalStylePath"
---

<objective>
Add database support for storing a locally cached style JSON file path per offline map region, and fetch+cache the style JSON during the offline map download process (while still online).

Purpose: This is the "write path" for the offline style fix. Without caching the style JSON locally during download, MapLibre's HTTP cache eventually expires and the map can't render tiles offline. By saving the style JSON as a local file and recording its path in the database, Plan 02 can load it when offline.

Output: Database migration, updated entity/DAO/repository, and style JSON caching logic in the download ViewModel.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-offline-map-tile-rendering/02.2-RESEARCH.md

Key source files to read before implementation:
@data/src/main/java/com/lxmf/messenger/data/db/entity/OfflineMapRegionEntity.kt
@data/src/main/java/com/lxmf/messenger/data/db/ColumbaDatabase.kt
@data/src/main/java/com/lxmf/messenger/data/di/DatabaseModule.kt
@data/src/main/java/com/lxmf/messenger/data/db/dao/OfflineMapRegionDao.kt
@data/src/main/java/com/lxmf/messenger/data/repository/OfflineMapRegionRepository.kt
@app/src/main/java/com/lxmf/messenger/viewmodel/OfflineMapDownloadViewModel.kt
@app/src/main/java/com/lxmf/messenger/map/MapLibreOfflineManager.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localStylePath to database schema and data layer</name>
  <files>
    data/src/main/java/com/lxmf/messenger/data/db/entity/OfflineMapRegionEntity.kt
    data/src/main/java/com/lxmf/messenger/data/db/ColumbaDatabase.kt
    data/src/main/java/com/lxmf/messenger/data/di/DatabaseModule.kt
    data/src/main/java/com/lxmf/messenger/data/db/dao/OfflineMapRegionDao.kt
    data/src/main/java/com/lxmf/messenger/data/repository/OfflineMapRegionRepository.kt
  </files>
  <action>
    1. **OfflineMapRegionEntity.kt**: Add a nullable `localStylePath: String? = null` field after the existing `maplibreRegionId` field. This stores the absolute path to the locally cached style JSON file.

    2. **ColumbaDatabase.kt**: Bump `version = 34` to `version = 35`.

    3. **DatabaseModule.kt**:
       - Add `MIGRATION_34_35` following the established pattern. The migration adds the `localStylePath` column:
         ```kotlin
         private val MIGRATION_34_35 =
             object : Migration(34, 35) {
                 override fun migrate(database: SupportSQLiteDatabase) {
                     database.execSQL(
                         "ALTER TABLE offline_map_regions ADD COLUMN localStylePath TEXT DEFAULT NULL"
                     )
                 }
             }
         ```
       - Add `MIGRATION_34_35` to the `ALL_MIGRATIONS` array (after `MIGRATION_33_34`).

    4. **OfflineMapRegionDao.kt**: Add an `updateLocalStylePath` method:
       ```kotlin
       @Query("UPDATE offline_map_regions SET localStylePath = :localStylePath WHERE id = :id")
       suspend fun updateLocalStylePath(id: Long, localStylePath: String)
       ```

    5. **OfflineMapRegionRepository.kt**:
       - Add `localStylePath` to the `OfflineMapRegion` data class (nullable String, default null).
       - Add `localStylePath = localStylePath` to the `toOfflineMapRegion()` extension function mapping.
       - Add a repository method:
         ```kotlin
         suspend fun updateLocalStylePath(id: Long, localStylePath: String) {
             offlineMapRegionDao.updateLocalStylePath(id, localStylePath)
         }
         ```
       - Add a method to get completed regions that have a local style path:
         ```kotlin
         suspend fun getFirstCompletedRegionWithStyle(): OfflineMapRegion? {
             // Reuse existing getCompletedRegions flow, take first emission, find first with localStylePath
         }
         ```
         Actually, a simpler approach: add a DAO query `getFirstCompletedRegionWithLocalStyle()` that returns the first completed region where `localStylePath IS NOT NULL`, then expose it through the repository. This avoids loading all completed regions.

    6. **OfflineMapRegionDao.kt**: Also add:
       ```kotlin
       @Query("SELECT * FROM offline_map_regions WHERE status = 'COMPLETE' AND localStylePath IS NOT NULL LIMIT 1")
       suspend fun getFirstCompletedRegionWithLocalStyle(): OfflineMapRegionEntity?
       ```
  </action>
  <verify>
    Build the data module: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:compileDebugKotlin` succeeds without errors.
  </verify>
  <done>
    - OfflineMapRegionEntity has `localStylePath: String? = null` field
    - Database version is 35 with MIGRATION_34_35 that adds the column
    - DAO has `updateLocalStylePath()` and `getFirstCompletedRegionWithLocalStyle()` methods
    - Repository has `updateLocalStylePath()` and `getFirstCompletedRegionWithStyle()` methods
    - OfflineMapRegion domain model includes `localStylePath` field
    - Data module compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Fetch and cache style JSON during offline map download</name>
  <files>
    app/src/main/java/com/lxmf/messenger/viewmodel/OfflineMapDownloadViewModel.kt
  </files>
  <action>
    Modify `OfflineMapDownloadViewModel.startDownload()` to fetch and cache the style JSON file after the download completes successfully (in the `onComplete` callback), while the device is still online.

    1. Add a private suspend function `fetchAndCacheStyleJson(regionId: Long)`:
       - Use OkHttp (already in the project) or `java.net.URL` to fetch the style JSON from `MapTileSourceManager.DEFAULT_STYLE_URL` (which is `https://tiles.openfreemap.org/styles/liberty`)
       - Save the JSON string to a local file at `context.filesDir/offline_styles/{regionId}.json`
       - Create the `offline_styles` directory if it doesn't exist (`parentFile?.mkdirs()`)
       - Call `offlineMapRegionRepository.updateLocalStylePath(regionId, styleFile.absolutePath)` to persist the path
       - Log success: `Log.d(TAG, "Cached style JSON for region $regionId")`
       - Wrap in try-catch: if fetching fails, log a warning but don't fail the download. The download is already complete and the tiles are saved. The style will work from HTTP cache until it expires.

    2. In the `onComplete` callback of `startDownload()`, after `markCompleteWithMaplibreId()`, call `fetchAndCacheStyleJson(regionId)`. This must be inside the `viewModelScope.launch` block that's already there in `onComplete`.

    3. Use `java.net.URL(url).readText()` wrapped in `withContext(Dispatchers.IO)` for the HTTP fetch. This is simpler than bringing in OkHttp since it's a single one-shot GET request. Example:
       ```kotlin
       private suspend fun fetchAndCacheStyleJson(regionId: Long) {
           withContext(Dispatchers.IO) {
               try {
                   val styleJson = java.net.URL(MapTileSourceManager.DEFAULT_STYLE_URL).readText()
                   val styleDir = java.io.File(context.filesDir, "offline_styles")
                   styleDir.mkdirs()
                   val styleFile = java.io.File(styleDir, "$regionId.json")
                   styleFile.writeText(styleJson)
                   offlineMapRegionRepository.updateLocalStylePath(regionId, styleFile.absolutePath)
                   Log.d(TAG, "Cached style JSON for region $regionId at ${styleFile.absolutePath}")
               } catch (e: Exception) {
                   Log.w(TAG, "Failed to cache style JSON for region $regionId (non-fatal)", e)
               }
           }
       }
       ```

    4. Add the necessary import for `kotlinx.coroutines.withContext` if not already present.

    **Important:** Do NOT add the style fetching to the `onCreated` callback. At that point the download hasn't started yet and we want to cache AFTER the download succeeds (confirming the user is still online and committed to this region).
  </action>
  <verify>
    Build the app module: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin` succeeds without errors.
  </verify>
  <done>
    - Style JSON is fetched from DEFAULT_STYLE_URL after successful download completion
    - Style JSON is saved to `context.filesDir/offline_styles/{regionId}.json`
    - Local file path is persisted to database via `updateLocalStylePath()`
    - Failure to cache style JSON is non-fatal (logged as warning, download still marked complete)
    - App module compiles successfully
  </done>
</task>

</tasks>

<verification>
1. `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:compileDebugKotlin :app:compileDebugKotlin` both succeed
2. Run existing tests: `cd /home/tyler/repos/public/columba && JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:testDebugUnitTest :app:testDebugUnitTest` passes (no regressions)
3. Review OfflineMapRegionEntity has `localStylePath` field
4. Review DatabaseModule has MIGRATION_34_35
5. Review OfflineMapDownloadViewModel has `fetchAndCacheStyleJson` method called in `onComplete`
</verification>

<success_criteria>
- Database schema supports storing local style JSON path per offline map region
- Migration 34->35 safely adds the column
- During offline map download, style JSON is fetched and cached locally
- File is saved at a predictable path (`filesDir/offline_styles/{regionId}.json`)
- Path is persisted in the database for retrieval by Plan 02
- Existing functionality (download progress, completion, error handling) is not broken
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-offline-map-tile-rendering/02.2-01-SUMMARY.md`
</output>
