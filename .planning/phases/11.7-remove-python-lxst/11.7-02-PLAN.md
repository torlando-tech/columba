---
phase: 11.7-remove-python-lxst
plan: 02
type: execute
wave: 2
depends_on: ["11.7-01"]
files_modified:
  - reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt
  - reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt
  - app/build.gradle.kts
autonomous: false

must_haves:
  truths:
    - "PythonNetworkTransport has no setKotlinAudioActive method"
    - "Telephone.openPipelines() does not call setKotlinAudioActive"
    - "Telephone.stopPipelines() does not call setKotlinAudioActive"
    - "app/build.gradle.kts does not reference LXST wheel or extract LXST package"
    - "Project compiles successfully with JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin"
    - "Existing Telephone and Profile unit tests pass"
  artifacts:
    - path: "reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt"
      provides: "Clean NetworkTransport without Phase 11.6 flag method"
    - path: "reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt"
      provides: "Telephone without Phase 11.6 setKotlinAudioActive calls"
    - path: "app/build.gradle.kts"
      provides: "Build config without LXST wheel dependency"
  key_links:
    - from: "Telephone.kt openPipelines()"
      to: "PythonNetworkTransport"
      via: "No longer calls setKotlinAudioActive"
      pattern: "openPipelines.*does not contain.*setKotlinAudioActive"
    - from: "app/build.gradle.kts"
      to: "wheels/lxst/"
      via: "No longer references LXST wheel"
      pattern: "no lxst reference"
---

<objective>
Remove Phase 11.6 flag code from Kotlin layer and remove LXST wheel dependency from build. Verify the full project compiles and existing tests pass.

Purpose: Completes Phase 11.7 by cleaning up Kotlin-side references to the Phase 11.6 workaround and removing the 4.5MB LXST wheel from the build. After this, LXST is fully eliminated from the codebase.

Output: Clean PythonNetworkTransport.kt, clean Telephone.kt, clean build.gradle.kts. Verified compilation and test passage.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.7-remove-python-lxst/11.7-RESEARCH.md
@.planning/phases/11.7-remove-python-lxst/11.7-01-SUMMARY.md
@reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt
@reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt
@app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Phase 11.6 code from Kotlin and LXST from build</name>
  <files>
    reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt
    reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt
    app/build.gradle.kts
  </files>
  <action>
**PythonNetworkTransport.kt** — Remove the `setKotlinAudioActive()` method (lines 182-197):
```kotlin
// DELETE THIS ENTIRE BLOCK:
/**
 * Enable/disable Python LXST audio when Kotlin LXST handles audio.
 *
 * When true, Python recorder returns silence and player drops frames.
 * This prevents dual audio pipeline conflict.
 */
fun setKotlinAudioActive(active: Boolean) {
    CoroutineScope(Dispatchers.IO).launch {
        try {
            callManager.callAttr("set_kotlin_audio_active", active)
            Log.d(TAG, "Set Kotlin audio active: $active")
        } catch (e: Exception) {
            Log.e(TAG, "Error setting Kotlin audio active: ${e.message}")
        }
    }
}
```

Also check if the `CoroutineScope` and `launch` imports are still needed after removal. The class still uses `withContext(Dispatchers.IO)` in `establishLink()`, so keep `Dispatchers` and `withContext`. But check if `CoroutineScope` and `launch` are used elsewhere — if `setKotlinAudioActive` was the ONLY usage of `CoroutineScope(Dispatchers.IO).launch`, remove the `CoroutineScope` and `launch` imports (keep `Dispatchers`, `withContext`).

Review: Looking at the file, `CoroutineScope` and `launch` are ONLY used in `setKotlinAudioActive`. Remove those imports but keep `Dispatchers` and `withContext`.

**Telephone.kt** — Remove two lines that call setKotlinAudioActive:

In `openPipelines()` (around line 595):
```kotlin
// DELETE THIS LINE:
(networkTransport as? PythonNetworkTransport)?.setKotlinAudioActive(true)
```

In `stopPipelines()` (around line 680):
```kotlin
// DELETE THIS LINE:
(networkTransport as? PythonNetworkTransport)?.setKotlinAudioActive(false)
```

After removing these lines, check if `PythonNetworkTransport` is still imported in Telephone.kt. Search for other usages of PythonNetworkTransport in Telephone.kt — if these were the only two references, the import can be removed.

**app/build.gradle.kts** — Remove LXST dependency:

1. Remove the LXST wheel lines (around lines 350-353):
```kotlin
// DELETE THESE LINES:
// LXST wheel with pre-compiled Android filterlib .so files
// Built as pure Python wheel with .so files as package_data
options("--find-links", file("../wheels/lxst").absolutePath)
install("lxst==0.4.5")
```

2. Remove "LXST" from extractPackages (around line 372):
Change: `extractPackages("ble_reticulum", "ble_modules", "pycodec2", "LXST")`
To: `extractPackages("ble_reticulum", "ble_modules", "pycodec2")`

3. Update the comment on line 371 to remove LXST reference:
Change: `// LXST needs to be extracted so filterlib.*.so can be loaded via cffi.dlopen()`
To: `// pycodec2 needs libcodec2.so extracted at runtime`

4. Update the comment on line 358:
Change: `// Install requirements from requirements.txt (LXST installed above via wheel)`
To: `// Install requirements from requirements.txt`
  </action>
  <verify>
- `grep "setKotlinAudioActive" reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/PythonNetworkTransport.kt` returns NO results
- `grep "setKotlinAudioActive" reticulum/src/main/java/com/lxmf/messenger/reticulum/call/telephone/Telephone.kt` returns NO results
- `grep -i "lxst" app/build.gradle.kts` returns NO results (only the Kotlin LXST comment on line ~453 about Opus should remain — check it says "Kotlin LXST" not Python LXST)
- `grep "LXST" app/build.gradle.kts` — only the Kotlin Opus codec comment should remain
  </verify>
  <done>
PythonNetworkTransport.kt has no setKotlinAudioActive method. Telephone.kt has no setKotlinAudioActive calls. app/build.gradle.kts has no LXST wheel dependency or extract package entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compile and run unit tests</name>
  <files></files>
  <action>
Run compilation and unit tests to verify nothing is broken:

1. **Compile the reticulum module:**
```bash
JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin
```

2. **Run Telephone and Profile unit tests:**
```bash
JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:testDebugUnitTest --tests "*.ProfileTest" --tests "*.TelephoneTest"
```

If compilation fails:
- Check for unused import errors (Kotlin compiler warnings about unused imports)
- Check PythonNetworkTransport import in Telephone.kt — if it was only used for setKotlinAudioActive casts, it may need removal
- Check CoroutineScope/launch import in PythonNetworkTransport.kt

If tests fail:
- Check if any test mocks setKotlinAudioActive — those mock setups should be removed
- Check if any test verifies setKotlinAudioActive calls — those assertions should be removed
- Carefully evaluate whether failures indicate broken production code vs test-specific issues
  </action>
  <verify>
- `:reticulum:compileDebugKotlin` succeeds with BUILD SUCCESSFUL
- `:reticulum:testDebugUnitTest` for ProfileTest and TelephoneTest passes
  </verify>
  <done>
Project compiles and all 101 unit tests (42 ProfileTest + 59 TelephoneTest) pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 11.7 complete: Python LXST removed from codebase. call_manager.py rewritten with raw Reticulum Link APIs. Phase 11.6 flag code removed from both Python and Kotlin. LXST wheel removed from build.

Changes summary:
- call_manager.py: Rewritten (~300 lines) — raw RNS.Link, RNS.Packet, RNS.Destination, umsgpack wire format
- lxst_debug_instrumentation.py: DELETED
- chaquopy_audio_backend.py: Phase 11.6 _kotlin_audio_active flag removed
- PythonNetworkTransport.kt: setKotlinAudioActive() removed
- Telephone.kt: Two setKotlinAudioActive() calls removed from openPipelines/stopPipelines
- app/build.gradle.kts: LXST wheel install and extractPackages removed
  </what-built>
  <how-to-verify>
1. Verify compilation: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin` succeeds
2. Verify tests: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:testDebugUnitTest --tests "*.ProfileTest" --tests "*.TelephoneTest"` passes
3. Verify no LXST imports: `grep -r "from LXST\|import LXST" python/lxst_modules/` returns nothing
4. Verify wire format constants in call_manager.py: `grep "FIELD_SIGNALLING\|FIELD_FRAMES" python/lxst_modules/call_manager.py`
5. Optional: Build APK and test a call on device to verify audio works end-to-end
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Phase 12, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `grep -r "from LXST\|import LXST" python/ reticulum/` returns NO results in any source file
2. `grep -r "setKotlinAudioActive\|set_kotlin_audio_active\|_kotlin_audio_active" python/ reticulum/` returns NO results
3. `grep -r "lxst_debug_instrumentation" python/` returns NO results
4. `grep -i "lxst" app/build.gradle.kts` — only Kotlin LXST Opus comment remains (line ~453)
5. `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:compileDebugKotlin` succeeds
6. `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :reticulum:testDebugUnitTest --tests "*.ProfileTest" --tests "*.TelephoneTest"` passes
</verification>

<success_criteria>
- Phase 11.6 flag code eliminated from Kotlin layer
- LXST wheel dependency removed from build
- Project compiles successfully
- All existing unit tests pass
- Human verification of overall Phase 11.7 completeness
</success_criteria>

<output>
After completion, create `.planning/phases/11.7-remove-python-lxst/11.7-02-SUMMARY.md`
</output>
