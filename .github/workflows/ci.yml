name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write  # Required for fail-fast workflow cancellation

jobs:
  validate-wrapper:
    name: Validate Gradle Wrapper
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

  lint:
    name: Code Quality (ktlint + detekt + CPD)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run all lint checks
        run: ./gradlew ktlintCheck detekt cpdCheck --continue

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-reports
          path: |
            **/build/reports/ktlint/
            **/build/reports/detekt/
            build/reports/cpd/
          retention-days: 7

  threading-audit:
    name: Threading Architecture Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Make audit script executable
        run: chmod +x audit-dispatchers.sh

      - name: Run dispatcher audit
        id: audit
        run: |
          echo "Running threading architecture audit..."
          ./audit-dispatchers.sh
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: threading-audit-report
          path: dispatcher-audit-report.txt
          retention-days: 30

      - name: Comment audit results on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'Dispatcher audit report not found';
            try {
              report = fs.readFileSync('dispatcher-audit-report.txt', 'utf8');
            } catch (e) {
              console.log('Could not read audit report');
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Threading Architecture Audit Failed\n\n<details><summary>View Audit Report</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>\n\nPlease fix the dispatcher violations before merging.`
            });

  proguard-verification:
    name: Verify ProGuard Rules (Python-Kotlin Bridge)
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: pip install build

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build release APK
        run: ./gradlew :app:assembleRelease --stacktrace --max-workers=2
        env:
          # Use debug signing for CI verification (no release keystore needed)
          RELEASE_STORE_FILE: ""
          RELEASE_STORE_PASSWORD: ""
          RELEASE_KEY_ALIAS: ""
          RELEASE_KEY_PASSWORD: ""

      - name: Verify Python-Kotlin bridge methods are not obfuscated
        run: |
          # Find the release APK
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: No release APK found!"
            exit 1
          fi
          # Run dynamic verification script that extracts methods from Python source
          python scripts/verify_proguard_bridge.py "$APK_PATH"

      - name: Upload R8 mapping file
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: r8-mapping
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 30

      - name: Cancel workflow on failure (fail-fast)
        if: failure()
        run: gh run cancel ${{ github.run_id }}
        env:
          GH_TOKEN: ${{ github.token }}

  python-tests:
    name: Python Tests
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install build pytest pytest-cov pytest-xdist u-msgpack-python numpy

      - name: Run Python unit tests with coverage
        run: |
          cd python && python -m pytest -v -n auto --dist loadfile \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:coverage-python.xml

      - name: Upload Python coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./python/coverage-python.xml
          flags: python
          name: codecov-python
          fail_ci_if_error: false
          verbose: true

      - name: Upload Python coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: python-coverage-report
          path: python/coverage-python.xml
          retention-days: 7

      - name: Cancel workflow on failure (fail-fast)
        if: failure()
        run: gh run cancel ${{ github.run_id }}
        env:
          GH_TOKEN: ${{ github.token }}

  kotlin-tests:
    name: Kotlin Tests
    needs: [lint, validate-wrapper]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: pip install build

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean AIDL generated code
        run: |
          # Clean AIDL generated code to avoid stale cache issues
          # This MUST happen before Gradle cache restore to prevent cached stale AIDL files
          rm -rf app/build/generated/aidl_source_output_dir
          rm -rf */build/generated/aidl_source_output_dir

      - name: Clean JaCoCo execution data
        run: |
          # Clean stale JaCoCo execution data to avoid "exceeds max age" errors in Codecov
          rm -rf build/jacoco
          rm -rf */build/jacoco
          rm -rf build/reports/jacoco
          rm -rf */build/reports/jacoco

      - name: Run unit tests and generate coverage report
        run: ./gradlew testDebugUnitTest jacocoTestReport --stacktrace --max-workers=4 --no-build-cache

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-test-results
          path: |
            **/build/test-results/test*/*.xml
            **/build/test-results/test*/*.html
          retention-days: 7

      - name: Upload unit test reports
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-test-reports
          path: |
            **/build/reports/tests/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Upload Kotlin coverage reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: kotlin-coverage-reports
          path: |
            **/build/reports/jacoco/
          retention-days: 7

      - name: Cancel workflow on failure (fail-fast)
        if: failure()
        run: gh run cancel ${{ github.run_id }}
        env:
          GH_TOKEN: ${{ github.token }}

  # instrumented-tests:
  #   name: Instrumented Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 90

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #       with:
  #         submodules: recursive

  #     - name: Setup Gradle
  #       uses: gradle/actions/setup-gradle@v4
  #       with:
  #         cache-read-only: false

  #     - name: Set up Python
  #       uses: actions/setup-python@v6
  #       with:
  #         python-version: '3.11'

  #     - name: Install Python build dependencies
  #       run: pip install build

  #     - name: Grant execute permission for gradlew
  #       run: chmod +x gradlew

  #     - name: Clean AIDL generated code
  #       run: |
  #         # Clean AIDL generated code to avoid stale cache issues
  #         # This MUST happen before Gradle cache restore to prevent cached stale AIDL files
  #         rm -rf app/build/generated/aidl_source_output_dir
  #         rm -rf */build/generated/aidl_source_output_dir

  #     # KVM configuration is handled at k3s pod/host level for ubuntu-latest runners
  #     # No need for udev rules in containerized environment

  #     - name: Pre-build test APKs to reduce emulator load
  #       run: |
  #         echo "Building APKs before starting emulator to reduce resource contention..."
  #         ./gradlew :app:assembleDebugAndroidTest --stacktrace --max-workers=2
  #         ./gradlew :app:assembleDebug --stacktrace --max-workers=2
  #         echo "APKs built successfully"

  #     - name: Clear stale emulator state
  #       run: |
  #         # Kill any emulators
  #         adb devices | grep emulator | cut -f1 | xargs -I {} adb -s {} emu kill || true
  #         sleep 2
  #         # Force kill qemu processes
  #         pkill -9 qemu-system-x86_64 || true
  #         pkill -9 qemu-system || true
  #         # Kill ADB and wait for ports to free
  #         adb kill-server || true
  #         sleep 2
  #         # Check if port 5554 is in use and kill the process
  #         lsof -ti:5554 | xargs kill -9 || true
  #         lsof -ti:5555 | xargs kill -9 || true
  #         sleep 1
  #         # Clean temp files
  #         rm -rf /tmp/android-* || true
  #         rm -rf /tmp/avd-* || true
  #         # Start fresh ADB server
  #         adb start-server
  #         sleep 2
  #         # Verify no emulators running
  #         adb devices

  #     - name: AVD cache
  #       uses: actions/cache@v4
  #       id: avd-cache
  #       with:
  #         path: |
  #           ~/.android/avd/*
  #           ~/.android/adb*
  #         key: avd-34-x86_64-v5-2gb

  #     - name: Create AVD and generate snapshot for caching
  #       if: steps.avd-cache.outputs.cache-hit != 'true'
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         api-level: 34
  #         arch: x86_64
  #         target: google_apis
  #         force-avd-creation: false
  #         emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -memory 2048 -accel on
  #         disable-animations: true
  #         emulator-boot-timeout: 900
  #         script: echo "Waiting for input service to be available..." && i=0 && while [ $i -lt 30 ]; do if adb shell service check input >/dev/null 2>&1; then echo "Input service is available" && break; fi; i=$((i + 1)); echo "Waiting for input service... ($i/30)"; sleep 2; done && echo "Generated AVD snapshot for caching."

  #     - name: Run instrumented tests
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         api-level: 34
  #         arch: x86_64
  #         target: google_apis
  #         force-avd-creation: false
  #         emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -memory 2048 -accel on
  #         disable-animations: true
  #         emulator-boot-timeout: 600
  #         script: |
  #           echo "Running emulator health check..." && adb shell getprop ro.build.version.sdk && adb shell pm list packages | head -5 && echo "Emulator is responsive, starting tests..." && ./gradlew :app:connectedDebugAndroidTest --stacktrace

  #     - name: Upload instrumented test results
  #       if: always()
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: instrumented-test-results
  #         path: |
  #           **/build/outputs/androidTest-results/**/*.xml
  #           **/build/outputs/androidTest-results/**/*.html
  #         retention-days: 7

  #     - name: Upload instrumented test reports
  #       if: failure()
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: instrumented-test-reports
  #         path: |
  #           **/build/reports/androidTests/
  #         retention-days: 7

  #     - name: Upload logcat output
  #       if: failure()
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: logcat
  #         path: artifacts/logcat.log
  #         retention-days: 7
  #         if-no-files-found: ignore

  #     - name: Cleanup emulator
  #       if: always()
  #       run: |
  #         adb devices | grep emulator | cut -f1 | xargs -I {} adb -s {} emu kill || true
  #         pkill -9 qemu-system || true
  #       adb kill-server || true
